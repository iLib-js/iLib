<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="COMM">/*
<span class='line'>  2</span>  * PhoneNumber.js - Represent a phone number.
<span class='line'>  3</span>  *
<span class='line'>  4</span>  * Copyright Â© 2014-2015, 2018, JEDLSoft
<span class='line'>  5</span>  *
<span class='line'>  6</span>  * Licensed under the Apache License, Version 2.0 (the "License");
<span class='line'>  7</span>  * you may not use this file except in compliance with the License.
<span class='line'>  8</span>  * You may obtain a copy of the License at
<span class='line'>  9</span>  *
<span class='line'> 10</span>  *     http://www.apache.org/licenses/LICENSE-2.0
<span class='line'> 11</span>  *
<span class='line'> 12</span>  * Unless required by applicable law or agreed to in writing, software
<span class='line'> 13</span>  * distributed under the License is distributed on an "AS IS" BASIS,
<span class='line'> 14</span>  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
<span class='line'> 15</span>  *
<span class='line'> 16</span>  * See the License for the specific language governing permissions and
<span class='line'> 17</span>  * limitations under the License.
<span class='line'> 18</span>  */</span><span class="WHIT">
<span class='line'> 19</span> 
<span class='line'> 20</span> </span><span class="COMM">// !data states idd mnc</span><span class="WHIT">
<span class='line'> 21</span> 
<span class='line'> 22</span> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ilib</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">require</span><span class="PUNC">(</span><span class="STRN">"./ilib.js"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 23</span> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">Utils</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">require</span><span class="PUNC">(</span><span class="STRN">"./Utils.js"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 24</span> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">JSUtils</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">require</span><span class="PUNC">(</span><span class="STRN">"./JSUtils.js"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 25</span> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">NumberingPlan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">require</span><span class="PUNC">(</span><span class="STRN">"./NumberingPlan.js"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 26</span> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">PhoneLocale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">require</span><span class="PUNC">(</span><span class="STRN">"./PhoneLocale.js"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 27</span> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">PhoneHandlerFactory</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">require</span><span class="PUNC">(</span><span class="STRN">"./PhoneHandlerFactory.js"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 28</span> 
<span class='line'> 29</span> </span><span class="COMM">/**
<span class='line'> 30</span>  * @class
<span class='line'> 31</span>  * Create a new phone number instance that parses the phone number parameter for its
<span class='line'> 32</span>  * constituent parts, and store them as separate fields in the returned object.
<span class='line'> 33</span>  *
<span class='line'> 34</span>  * The options object may include any of these properties:
<span class='line'> 35</span>  *
<span class='line'> 36</span>  * &lt;ul>
<span class='line'> 37</span>  * &lt;li>&lt;i>locale&lt;/i> The locale with which to parse the number. This gives a clue as to which
<span class='line'> 38</span>  * numbering plan to use.
<span class='line'> 39</span>  * &lt;li>&lt;i>mcc&lt;/i> The mobile carrier code (MCC) associated with the carrier that the phone is
<span class='line'> 40</span>  * currently connected to, if known. This also can give a clue as to which numbering plan to
<span class='line'> 41</span>  * use
<span class='line'> 42</span>  * &lt;li>onLoad - a callback function to call when this instance is fully
<span class='line'> 43</span>  * loaded. When the onLoad option is given, this class will attempt to
<span class='line'> 44</span>  * load any missing locale data using the ilib loader callback.
<span class='line'> 45</span>  * When the constructor is done (even if the data is already preassembled), the
<span class='line'> 46</span>  * onLoad function is called with the current instance as a parameter, so this
<span class='line'> 47</span>  * callback can be used with preassembled or dynamic loading or a mix of the two.
<span class='line'> 48</span>  * &lt;li>sync - tell whether to load any missing locale data synchronously or
<span class='line'> 49</span>  * asynchronously. If this option is given as "false", then the "onLoad"
<span class='line'> 50</span>  * callback must be given, as the instance returned from this constructor will
<span class='line'> 51</span>  * not be usable for a while.
<span class='line'> 52</span>  * &lt;li>&lt;i>loadParams&lt;/i> - an object containing parameters to pass to the
<span class='line'> 53</span>  * loader callback function when locale data is missing. The parameters are not
<span class='line'> 54</span>  * interpretted or modified in any way. They are simply passed along. The object
<span class='line'> 55</span>  * may contain any property/value pairs as long as the calling code is in
<span class='line'> 56</span>  * agreement with the loader callback function as to what those parameters mean.
<span class='line'> 57</span>  * &lt;/ul>
<span class='line'> 58</span>  *
<span class='line'> 59</span>  * This function is locale-sensitive, and will assume any number passed to it is
<span class='line'> 60</span>  * appropriate for the given locale. If the MCC is given, this method will assume
<span class='line'> 61</span>  * that numbers without an explicit country code have been dialled within the country
<span class='line'> 62</span>  * given by the MCC. This affects how things like area codes are parsed. If the MCC
<span class='line'> 63</span>  * is not given, this method will use the given locale to determine the country
<span class='line'> 64</span>  * code. If the locale is not explicitly given either, then this function uses the
<span class='line'> 65</span>  * region of current locale as the default.&lt;p>
<span class='line'> 66</span>  *
<span class='line'> 67</span>  * The input number may contain any formatting characters for the given locale. Each
<span class='line'> 68</span>  * field that is returned in the json object is a simple string of digits with
<span class='line'> 69</span>  * all formatting and whitespace characters removed.&lt;p>
<span class='line'> 70</span>  *
<span class='line'> 71</span>  * The number is decomposed into its parts, regardless if the number
<span class='line'> 72</span>  * contains formatting characters. If a particular part cannot be extracted from given
<span class='line'> 73</span>  * number, the field will not be returned as a field in the object. If no fields can be
<span class='line'> 74</span>  * extracted from the number at all, then all digits found in the string will be
<span class='line'> 75</span>  * returned in the subscriberNumber field. If the number parameter contains no
<span class='line'> 76</span>  * digits, an empty object is returned.&lt;p>
<span class='line'> 77</span>  *
<span class='line'> 78</span>  * This instance can contain any of the following fields after parsing is done:
<span class='line'> 79</span>  *
<span class='line'> 80</span>  * &lt;ul>
<span class='line'> 81</span>  * &lt;li>vsc - if this number starts with a VSC (Vertical Service Code, or "star code"), this field will contain the star and the code together
<span class='line'> 82</span>  * &lt;li>iddPrefix - the prefix for international direct dialing. This can either be in the form of a plus character or the IDD access code for the given locale
<span class='line'> 83</span>  * &lt;li>countryCode - if this number is an international direct dial number, this is the country code
<span class='line'> 84</span>  * &lt;li>cic - for "dial-around" services (access to other carriers), this is the prefix used as the carrier identification code
<span class='line'> 85</span>  * &lt;li>emergency - an emergency services number
<span class='line'> 86</span>  * &lt;li>mobilePrefix - prefix that introduces a mobile phone number
<span class='line'> 87</span>  * &lt;li>trunkAccess - trunk access code (long-distance access)
<span class='line'> 88</span>  * &lt;li>serviceCode - like a geographic area code, but it is a required prefix for various services
<span class='line'> 89</span>  * &lt;li>areaCode - geographic area codes
<span class='line'> 90</span>  * &lt;li>subscriberNumber - the unique number of the person or company that pays for this phone line
<span class='line'> 91</span>  * &lt;li>extension - in some countries, extensions are dialed directly without going through an operator or a voice prompt system. If the number includes an extension, it is given in this field.
<span class='line'> 92</span>  * &lt;li>invalid - this property is added and set to true if the parser found that the number is invalid in the numbering plan for the country. This method will make its best effort at parsing, but any digits after the error will go into the subscriberNumber field
<span class='line'> 93</span>  * &lt;/ul>
<span class='line'> 94</span>  *
<span class='line'> 95</span>  * The following rules determine how the number is parsed:
<span class='line'> 96</span>  *
<span class='line'> 97</span>  * &lt;ol>
<span class='line'> 98</span>  * &lt;li>If the number starts with a character that is alphabetic instead of numeric, do
<span class='line'> 99</span>  * not parse the number at all. There is a good chance that it is not really a phone number.
<span class='line'>100</span>  * In this case, an empty instance will be returned.
<span class='line'>101</span>  * &lt;li>If the phone number uses the plus notation or explicitly uses the international direct
<span class='line'>102</span>  * dialing prefix for the given locale, then the country code is identified in
<span class='line'>103</span>  * the number. The rules of given locale are used to parse the IDD prefix, and then the rules
<span class='line'>104</span>  * of the country in the prefix are used to parse the rest of the number.
<span class='line'>105</span>  * &lt;li>If a country code is provided as an argument to the function call, use that country's
<span class='line'>106</span>  * parsing rules for the number. This is intended for programs like a Contacts application that
<span class='line'>107</span>  * know what the country is of the person that owns the phone number and can pass that on as
<span class='line'>108</span>  * a hint.
<span class='line'>109</span>  * &lt;li>If the appropriate locale cannot be easily determined, default to using the rules
<span class='line'>110</span>  * for the current user's region.
<span class='line'>111</span>  * &lt;/ol>
<span class='line'>112</span>  *
<span class='line'>113</span>  * Example: parsing the number "+49 02101345345-78" will give the following properties in the
<span class='line'>114</span>  * resulting phone number instance:
<span class='line'>115</span>  *
<span class='line'>116</span>  * &lt;pre>
<span class='line'>117</span>  *      {
<span class='line'>118</span>  *        iddPrefix: "+",
<span class='line'>119</span>  *        countryCode: "49",
<span class='line'>120</span>  *        areaCode: "02101",
<span class='line'>121</span>  *        subscriberNumber: "345345",
<span class='line'>122</span>  *        extension: "78"
<span class='line'>123</span>  *      }
<span class='line'>124</span>  * &lt;/pre>
<span class='line'>125</span>  *
<span class='line'>126</span>  * Note that in this example, because international direct dialing is explicitly used
<span class='line'>127</span>  * in the number, the part of this number after the IDD prefix and country code will be
<span class='line'>128</span>  * parsed exactly the same way in all locales with German rules (country code 49).
<span class='line'>129</span>  *
<span class='line'>130</span>  * Regions currently supported are:
<span class='line'>131</span>  *
<span class='line'>132</span>  * &lt;ul>
<span class='line'>133</span>  * &lt;li>NANP (North American Numbering Plan) countries - USA, Canada, Bermuda, various Caribbean nations
<span class='line'>134</span>  * &lt;li>UK
<span class='line'>135</span>  * &lt;li>Republic of Ireland
<span class='line'>136</span>  * &lt;li>Germany
<span class='line'>137</span>  * &lt;li>France
<span class='line'>138</span>  * &lt;li>Spain
<span class='line'>139</span>  * &lt;li>Italy
<span class='line'>140</span>  * &lt;li>Mexico
<span class='line'>141</span>  * &lt;li>India
<span class='line'>142</span>  * &lt;li>People's Republic of China
<span class='line'>143</span>  * &lt;li>Netherlands
<span class='line'>144</span>  * &lt;li>Belgium
<span class='line'>145</span>  * &lt;li>Luxembourg
<span class='line'>146</span>  * &lt;li>Australia
<span class='line'>147</span>  * &lt;li>New Zealand
<span class='line'>148</span>  * &lt;li>Singapore
<span class='line'>149</span>  * &lt;li>Korea
<span class='line'>150</span>  * &lt;li>Japan
<span class='line'>151</span>  * &lt;li>Russia
<span class='line'>152</span>  * &lt;li>Brazil
<span class='line'>153</span>  * &lt;/ul>
<span class='line'>154</span>  *
<span class='line'>155</span>  * @constructor
<span class='line'>156</span>  * @param {!string|PhoneNumber} number A free-form phone number to be parsed, or another phone
<span class='line'>157</span>  * number instance to copy
<span class='line'>158</span>  * @param {Object=} options options that guide the parser in parsing the number
<span class='line'>159</span>  */</span><span class="WHIT">
<span class='line'>160</span> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">PhoneNumber</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">number</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>161</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stateData</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>162</span> </span><span class="WHIT">        </span><span class="NAME">regionSettings</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>163</span> 
<span class='line'>164</span> </span><span class="WHIT">    </span><span class="NAME">this.sync</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>165</span> </span><span class="WHIT">    </span><span class="NAME">this.loadParams</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>166</span> 
<span class='line'>167</span> 
<span class='line'>168</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>169</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.sync</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'boolean'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>170</span> </span><span class="WHIT">            </span><span class="NAME">this.sync</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">options.sync</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>171</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>172</span> 
<span class='line'>173</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options.loadParams</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>174</span> </span><span class="WHIT">            </span><span class="NAME">this.loadParams</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">options.loadParams</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>175</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>176</span> 
<span class='line'>177</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.onLoad</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>178</span> </span><span class="WHIT">            </span><span class="COMM">/**
<span class='line'>179</span>              * @private
<span class='line'>180</span>              * @type {function(PhoneNumber)}
<span class='line'>181</span>              */</span><span class="WHIT">
<span class='line'>182</span> </span><span class="WHIT">            </span><span class="NAME">this.onLoad</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">options.onLoad</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>183</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>184</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>185</span> </span><span class="WHIT">        </span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>186</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>187</span> 
<span class='line'>188</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">number</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">number</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"string"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">number.length</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>189</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.onLoad</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>190</span> </span><span class="WHIT">            </span><span class="NAME">options.onLoad</span><span class="PUNC">(</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>191</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>192</span> 
<span class='line'>193</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>194</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>195</span> 
<span class='line'>196</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">number</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"object"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>197</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>198</span>          * The vertical service code. These are codes that typically
<span class='line'>199</span>          * start with a star or hash, like "*69" for "dial back the
<span class='line'>200</span>          * last number that called me".
<span class='line'>201</span>          * @type {string|undefined}
<span class='line'>202</span>          */</span><span class="WHIT">
<span class='line'>203</span> </span><span class="WHIT">        </span><span class="NAME">this.vsc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.vsc</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>204</span> 
<span class='line'>205</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>206</span>          * The international direct dialing prefix. This is always
<span class='line'>207</span>          * followed by the country code.
<span class='line'>208</span>          * @type {string}
<span class='line'>209</span>          */</span><span class="WHIT">
<span class='line'>210</span> </span><span class="WHIT">        </span><span class="NAME">this.iddPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.iddPrefix</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>211</span> 
<span class='line'>212</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>213</span>          * The unique IDD country code for the country where the
<span class='line'>214</span>          * phone number is serviced.
<span class='line'>215</span>          * @type {string|undefined}
<span class='line'>216</span>          */</span><span class="WHIT">
<span class='line'>217</span> </span><span class="WHIT">        </span><span class="NAME">this.countryCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.countryCode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>218</span> 
<span class='line'>219</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>220</span>          * The digits required to access the trunk.
<span class='line'>221</span>          * @type {string|undefined}
<span class='line'>222</span>          */</span><span class="WHIT">
<span class='line'>223</span> </span><span class="WHIT">        </span><span class="NAME">this.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.trunkAccess</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>224</span> 
<span class='line'>225</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>226</span>          * The carrier identification code used to identify
<span class='line'>227</span>          * alternate long distance or international carriers.
<span class='line'>228</span>          * @type {string|undefined}
<span class='line'>229</span>          */</span><span class="WHIT">
<span class='line'>230</span> </span><span class="WHIT">        </span><span class="NAME">this.cic</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.cic</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>231</span> 
<span class='line'>232</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>233</span>          * Identifies an emergency number that is typically
<span class='line'>234</span>          * short, such as "911" in North America or "112" in
<span class='line'>235</span>          * many other places in the world.
<span class='line'>236</span>          * @type {string|undefined}
<span class='line'>237</span>          */</span><span class="WHIT">
<span class='line'>238</span> </span><span class="WHIT">        </span><span class="NAME">this.emergency</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.emergency</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>239</span> 
<span class='line'>240</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>241</span>          * The prefix of the subscriber number that indicates
<span class='line'>242</span>          * that this is the number of a mobile phone.
<span class='line'>243</span>          * @type {string|undefined}
<span class='line'>244</span>          */</span><span class="WHIT">
<span class='line'>245</span> </span><span class="WHIT">        </span><span class="NAME">this.mobilePrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.mobilePrefix</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>246</span> 
<span class='line'>247</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>248</span>          * The prefix that identifies this number as commercial
<span class='line'>249</span>          * service number.
<span class='line'>250</span>          * @type {string|undefined}
<span class='line'>251</span>          */</span><span class="WHIT">
<span class='line'>252</span> </span><span class="WHIT">        </span><span class="NAME">this.serviceCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.serviceCode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>253</span> 
<span class='line'>254</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>255</span>          * The area code prefix of a land line number.
<span class='line'>256</span>          * @type {string|undefined}
<span class='line'>257</span>          */</span><span class="WHIT">
<span class='line'>258</span> </span><span class="WHIT">        </span><span class="NAME">this.areaCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.areaCode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>259</span> 
<span class='line'>260</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>261</span>          * The unique number associated with the subscriber
<span class='line'>262</span>          * of this phone.
<span class='line'>263</span>          * @type {string|undefined}
<span class='line'>264</span>          */</span><span class="WHIT">
<span class='line'>265</span> </span><span class="WHIT">        </span><span class="NAME">this.subscriberNumber</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.subscriberNumber</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>266</span> 
<span class='line'>267</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>268</span>          * The direct dial extension number.
<span class='line'>269</span>          * @type {string|undefined}
<span class='line'>270</span>          */</span><span class="WHIT">
<span class='line'>271</span> </span><span class="WHIT">        </span><span class="NAME">this.extension</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.extension</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>272</span> 
<span class='line'>273</span> </span><span class="WHIT">        </span><span class="COMM">/**
<span class='line'>274</span>          * @private
<span class='line'>275</span>          * @type {boolean}
<span class='line'>276</span>          */</span><span class="WHIT">
<span class='line'>277</span> </span><span class="WHIT">        </span><span class="NAME">this.invalid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.invalid</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>278</span> 
<span class='line'>279</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">number.plan</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">number.locale</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>280</span> </span><span class="WHIT">            </span><span class="COMM">/**
<span class='line'>281</span>              * @private
<span class='line'>282</span>              * @type {NumberingPlan}
<span class='line'>283</span>              */</span><span class="WHIT">
<span class='line'>284</span> </span><span class="WHIT">            </span><span class="NAME">this.plan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.plan</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>285</span> 
<span class='line'>286</span> </span><span class="WHIT">            </span><span class="COMM">/**
<span class='line'>287</span>              * @private
<span class='line'>288</span>              * @type {PhoneLocale}
<span class='line'>289</span>              */</span><span class="WHIT">
<span class='line'>290</span> </span><span class="WHIT">            </span><span class="NAME">this.locale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.locale</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>291</span> 
<span class='line'>292</span> </span><span class="WHIT">            </span><span class="COMM">/**
<span class='line'>293</span>              * @private
<span class='line'>294</span>              * @type {NumberingPlan}
<span class='line'>295</span>              */</span><span class="WHIT">
<span class='line'>296</span> </span><span class="WHIT">            </span><span class="NAME">this.destinationPlan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.destinationPlan</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>297</span> 
<span class='line'>298</span> </span><span class="WHIT">            </span><span class="COMM">/**
<span class='line'>299</span>              * @private
<span class='line'>300</span>              * @type {PhoneLocale}
<span class='line'>301</span>              */</span><span class="WHIT">
<span class='line'>302</span> </span><span class="WHIT">            </span><span class="NAME">this.destinationLocale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">number.destinationLocale</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>303</span> 
<span class='line'>304</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.onLoad</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>305</span> </span><span class="WHIT">                </span><span class="NAME">options.onLoad</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>306</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>307</span> </span><span class="WHIT">            </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>308</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>309</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>310</span> 
<span class='line'>311</span> </span><span class="WHIT">    </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">PhoneLocale</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>312</span> </span><span class="WHIT">        </span><span class="NAME">locale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">options.locale</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>313</span> </span><span class="WHIT">        </span><span class="NAME">mcc</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">options.mcc</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>314</span> </span><span class="WHIT">        </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>315</span> </span><span class="WHIT">        </span><span class="NAME">loadParams</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.loadParams</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>316</span> </span><span class="WHIT">        </span><span class="NAME">onLoad</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">loc</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>317</span> </span><span class="WHIT">            </span><span class="NAME">this.locale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.destinationLocale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">loc</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>318</span> </span><span class="WHIT">            </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">NumberingPlan</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>319</span> </span><span class="WHIT">                </span><span class="NAME">locale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.locale</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>320</span> </span><span class="WHIT">                </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>321</span> </span><span class="WHIT">                </span><span class="NAME">loadParms</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.loadParams</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>322</span> </span><span class="WHIT">                </span><span class="NAME">onLoad</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">plan</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>323</span> </span><span class="WHIT">                    </span><span class="NAME">this.plan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.destinationPlan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">plan</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>324</span> 
<span class='line'>325</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">number</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"object"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>326</span> </span><span class="WHIT">                        </span><span class="COMM">// the copy constructor code above did not find the locale</span><span class="WHIT">
<span class='line'>327</span> </span><span class="WHIT">                        </span><span class="COMM">// or plan before, but now they are loaded, so we can return</span><span class="WHIT">
<span class='line'>328</span> </span><span class="WHIT">                        </span><span class="COMM">// already without going further</span><span class="WHIT">
<span class='line'>329</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.onLoad</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"function"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>330</span> </span><span class="WHIT">                            </span><span class="NAME">options.onLoad</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>331</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>332</span> </span><span class="WHIT">                        </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>333</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>334</span> </span><span class="WHIT">                    </span><span class="NAME">Utils.loadData</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>335</span> </span><span class="WHIT">                        </span><span class="NAME">name</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"states.json"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>336</span> </span><span class="WHIT">                        </span><span class="NAME">object</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"PhoneNumber"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>337</span> </span><span class="WHIT">                        </span><span class="NAME">locale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.locale</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>338</span> </span><span class="WHIT">                        </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>339</span> </span><span class="WHIT">                        </span><span class="NAME">loadParams</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">JSUtils.merge</span><span class="PUNC">(</span><span class="NAME">this.loadParams</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>340</span> </span><span class="WHIT">                            </span><span class="NAME">returnOne</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT">
<span class='line'>341</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>342</span> </span><span class="WHIT">                        </span><span class="NAME">callback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">stdata</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>343</span> </span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">stdata</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>344</span> </span><span class="WHIT">                                </span><span class="NAME">stdata</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._defaultStates</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>345</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>346</span> 
<span class='line'>347</span> </span><span class="WHIT">                            </span><span class="NAME">stateData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">stdata</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>348</span> 
<span class='line'>349</span> </span><span class="WHIT">                            </span><span class="NAME">regionSettings</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>350</span> </span><span class="WHIT">                                </span><span class="NAME">stateData</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stateData</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>351</span> </span><span class="WHIT">                                </span><span class="NAME">plan</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">plan</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>352</span> </span><span class="WHIT">                                </span><span class="NAME">handler</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">PhoneHandlerFactory</span><span class="PUNC">(</span><span class="NAME">this.locale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">plan</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>353</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>354</span> 
<span class='line'>355</span> </span><span class="WHIT">                            </span><span class="COMM">// use ^ to indicate the beginning of the number, because certain things only match at the beginning</span><span class="WHIT">
<span class='line'>356</span> </span><span class="WHIT">                            </span><span class="NAME">number</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"^"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">number.replace</span><span class="PUNC">(</span><span class="REGX">/\^/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>357</span> </span><span class="WHIT">                            </span><span class="NAME">number</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._stripFormatting</span><span class="PUNC">(</span><span class="NAME">number</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>358</span> 
<span class='line'>359</span> </span><span class="WHIT">                            </span><span class="NAME">this._parseNumber</span><span class="PUNC">(</span><span class="NAME">number</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionSettings</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>360</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>361</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>362</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>363</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>364</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>365</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>366</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>367</span> 
<span class='line'>368</span> </span><span class="COMM">/**
<span class='line'>369</span>  * Parse an International Mobile Subscriber Identity (IMSI) number into its 3 constituent parts:
<span class='line'>370</span>  *
<span class='line'>371</span>  * &lt;ol>
<span class='line'>372</span>  * &lt;li>mcc - Mobile Country Code, which identifies the country where the phone is currently receiving
<span class='line'>373</span>  * service.
<span class='line'>374</span>  * &lt;li>mnc - Mobile Network Code, which identifies the carrier which is currently providing service to the phone
<span class='line'>375</span>  * &lt;li>msin - Mobile Subscription Identifier Number. This is a unique number identifying the mobile phone on
<span class='line'>376</span>  * the network, which usually maps to an account/subscriber in the carrier's database.
<span class='line'>377</span>  * &lt;/ol>
<span class='line'>378</span>  *
<span class='line'>379</span>  * Because this function may need to load data to identify the above parts, you can pass an options
<span class='line'>380</span>  * object that controls how the data is loaded. The options may contain any of the following properties:
<span class='line'>381</span>  *
<span class='line'>382</span>  * &lt;ul>
<span class='line'>383</span>  * &lt;li>onLoad - a callback function to call when the parsing is done. When the onLoad option is given,
<span class='line'>384</span>  * this method will attempt to load the locale data using the ilib loader callback. When it is done
<span class='line'>385</span>  * (even if the data is already preassembled), the onLoad function is called with the parsing results
<span class='line'>386</span>  * as a parameter, so this callback can be used with preassembled or dynamic, synchronous or
<span class='line'>387</span>  * asynchronous loading or a mix of the above.
<span class='line'>388</span>  * &lt;li>sync - tell whether to load any missing locale data synchronously or asynchronously. If this
<span class='line'>389</span>  * option is given as "false", then the "onLoad" callback must be given, as the results returned from
<span class='line'>390</span>  * this constructor will not be usable for a while.
<span class='line'>391</span>  * &lt;li>&lt;i>loadParams&lt;/i> - an object containing parameters to pass to the loader callback function
<span class='line'>392</span>  * when locale data is missing. The parameters are not interpretted or modified in any way. They are
<span class='line'>393</span>  * simply passed along. The object may contain any property/value pairs as long as the calling code is in
<span class='line'>394</span>  * agreement with the loader callback function as to what those parameters mean.
<span class='line'>395</span>  * &lt;/ul>
<span class='line'>396</span>  *
<span class='line'>397</span>  * @static
<span class='line'>398</span>  * @param {string} imsi IMSI number to parse
<span class='line'>399</span>  * @param {Object} options options controlling the loading of the locale data
<span class='line'>400</span>  * @return {{mcc:string,mnc:string,msin:string}|undefined} components of the IMSI number, when the locale data
<span class='line'>401</span>  * is loaded synchronously, or undefined if asynchronous
<span class='line'>402</span>  */</span><span class="WHIT">
<span class='line'>403</span> </span><span class="NAME">PhoneNumber.parseImsi</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">imsi</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>404</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>405</span> </span><span class="WHIT">        </span><span class="NAME">loadParams</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>406</span> </span><span class="WHIT">        </span><span class="NAME">fields</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>407</span> 
<span class='line'>408</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">imsi</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>409</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.onLoad</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>410</span> </span><span class="WHIT">            </span><span class="NAME">options.onLoad</span><span class="PUNC">(</span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>411</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>412</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>413</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>414</span> 
<span class='line'>415</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>416</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.sync</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>417</span> </span><span class="WHIT">            </span><span class="NAME">sync</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">!</span><span class="NAME">options.sync</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>418</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>419</span> 
<span class='line'>420</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options.loadParams</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>421</span> </span><span class="WHIT">            </span><span class="NAME">loadParams</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">options.loadParams</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>422</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>423</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>424</span> 
<span class='line'>425</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ilib.data.mnc</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>426</span> </span><span class="WHIT">        </span><span class="NAME">fields</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._parseImsi</span><span class="PUNC">(</span><span class="NAME">ilib.data.mnc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">imsi</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>427</span> 
<span class='line'>428</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.onLoad</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>429</span> </span><span class="WHIT">            </span><span class="NAME">options.onLoad</span><span class="PUNC">(</span><span class="NAME">fields</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>430</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>431</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>432</span> </span><span class="WHIT">        </span><span class="NAME">Utils.loadData</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>433</span> </span><span class="WHIT">            </span><span class="NAME">name</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"mnc.json"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>434</span> </span><span class="WHIT">            </span><span class="NAME">object</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"PhoneNumber"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>435</span> </span><span class="WHIT">            </span><span class="NAME">nonlocale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>436</span> </span><span class="WHIT">            </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>437</span> </span><span class="WHIT">            </span><span class="NAME">loadParams</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>438</span> </span><span class="WHIT">            </span><span class="NAME">callback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">data</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>439</span> </span><span class="WHIT">                </span><span class="NAME">ilib.data.mnc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">data</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>440</span> </span><span class="WHIT">                </span><span class="NAME">fields</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._parseImsi</span><span class="PUNC">(</span><span class="NAME">data</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">imsi</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>441</span> 
<span class='line'>442</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.onLoad</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>443</span> </span><span class="WHIT">                    </span><span class="NAME">options.onLoad</span><span class="PUNC">(</span><span class="NAME">fields</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>444</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>445</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>446</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>447</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>448</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">fields</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>449</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>450</span> 
<span class='line'>451</span> 
<span class='line'>452</span> </span><span class="COMM">/**
<span class='line'>453</span>  * @static
<span class='line'>454</span>  * @protected
<span class='line'>455</span>  */</span><span class="WHIT">
<span class='line'>456</span> </span><span class="NAME">PhoneNumber._parseImsi</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">data</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">imsi</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>457</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ch</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>458</span> </span><span class="WHIT">        </span><span class="NAME">i</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>459</span> </span><span class="WHIT">        </span><span class="NAME">currentState</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>460</span> </span><span class="WHIT">        </span><span class="NAME">end</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>461</span> </span><span class="WHIT">        </span><span class="NAME">handlerMethod</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>462</span> </span><span class="WHIT">        </span><span class="NAME">newState</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>463</span> </span><span class="WHIT">        </span><span class="NAME">fields</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>464</span> </span><span class="WHIT">        </span><span class="NAME">lastLeaf</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>465</span> </span><span class="WHIT">        </span><span class="NAME">consumed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>466</span> 
<span class='line'>467</span> </span><span class="WHIT">    </span><span class="NAME">currentState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">data</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>468</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">currentState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>469</span> </span><span class="WHIT">        </span><span class="COMM">// can't parse anything</span><span class="WHIT">
<span class='line'>470</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>471</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>472</span> 
<span class='line'>473</span> </span><span class="WHIT">    </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>474</span> </span><span class="WHIT">    </span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">imsi.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>475</span> </span><span class="WHIT">        </span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._getCharacterCode</span><span class="PUNC">(</span><span class="NAME">imsi.charAt</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>476</span> </span><span class="WHIT">        </span><span class="COMM">// console.info("parsing char " + imsi.charAt(i) + " code: " + ch);</span><span class="WHIT">
<span class='line'>477</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>478</span> </span><span class="WHIT">            </span><span class="NAME">newState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentState.s</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentState.s</span><span class="PUNC">[</span><span class="NAME">ch</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>479</span> 
<span class='line'>480</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'object'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>481</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState.l</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>482</span> </span><span class="WHIT">                    </span><span class="COMM">// save for latter if needed</span><span class="WHIT">
<span class='line'>483</span> </span><span class="WHIT">                    </span><span class="NAME">lastLeaf</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newState</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>484</span> </span><span class="WHIT">                    </span><span class="NAME">consumed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>485</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>486</span> </span><span class="WHIT">                </span><span class="COMM">// console.info("recognized digit " + ch + " continuing...");</span><span class="WHIT">
<span class='line'>487</span> </span><span class="WHIT">                </span><span class="COMM">// recognized digit, so continue parsing</span><span class="WHIT">
<span class='line'>488</span> </span><span class="WHIT">                </span><span class="NAME">currentState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newState</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>489</span> </span><span class="WHIT">                </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>490</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>491</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">newState</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>492</span> </span><span class="WHIT">                    </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'object'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState.l</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>493</span> </span><span class="WHIT">                     </span><span class="NAME">lastLeaf</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>494</span> </span><span class="WHIT">                    </span><span class="COMM">// this is possibly a look-ahead and it didn't work...</span><span class="WHIT">
<span class='line'>495</span> </span><span class="WHIT">                    </span><span class="COMM">// so fall back to the last leaf and use that as the</span><span class="WHIT">
<span class='line'>496</span> </span><span class="WHIT">                    </span><span class="COMM">// final state</span><span class="WHIT">
<span class='line'>497</span> </span><span class="WHIT">                    </span><span class="NAME">newState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lastLeaf</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>498</span> </span><span class="WHIT">                    </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">consumed</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>499</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>500</span> 
<span class='line'>501</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'number'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>502</span> </span><span class="WHIT">                    </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'object'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState.l</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>503</span> </span><span class="WHIT">                    </span><span class="COMM">// final state</span><span class="WHIT">
<span class='line'>504</span> </span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stateNumber</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'number'</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">newState</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">newState.l</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>505</span> </span><span class="WHIT">                    </span><span class="NAME">handlerMethod</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._states</span><span class="PUNC">[</span><span class="NAME">stateNumber</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>506</span> 
<span class='line'>507</span> </span><span class="WHIT">                    </span><span class="COMM">// console.info("reached final state " + newState + " handler method is " + handlerMethod + " and i is " + i);</span><span class="WHIT">
<span class='line'>508</span> 
<span class='line'>509</span> </span><span class="WHIT">                    </span><span class="COMM">// deal with syntactic ambiguity by using the "special" end state instead of "area"</span><span class="WHIT">
<span class='line'>510</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">handlerMethod</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"area"</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>511</span> </span><span class="WHIT">                        </span><span class="NAME">end</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>512</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>513</span> </span><span class="WHIT">                        </span><span class="COMM">// unrecognized imsi, so just assume the mnc is 3 digits</span><span class="WHIT">
<span class='line'>514</span> </span><span class="WHIT">                        </span><span class="NAME">end</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">6</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>515</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>516</span> 
<span class='line'>517</span> </span><span class="WHIT">                    </span><span class="NAME">fields.mcc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imsi.substring</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NUMB">3</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>518</span> </span><span class="WHIT">                    </span><span class="NAME">fields.mnc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imsi.substring</span><span class="PUNC">(</span><span class="NUMB">3</span><span class="PUNC">,</span><span class="NAME">end</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>519</span> </span><span class="WHIT">                    </span><span class="NAME">fields.msin</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imsi.substring</span><span class="PUNC">(</span><span class="NAME">end</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>520</span> 
<span class='line'>521</span> </span><span class="WHIT">                    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">fields</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>522</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>523</span> </span><span class="WHIT">                    </span><span class="COMM">// parse error</span><span class="WHIT">
<span class='line'>524</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">imsi.length</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">6</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>525</span> </span><span class="WHIT">                        </span><span class="NAME">fields.mcc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imsi.substring</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NUMB">3</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>526</span> </span><span class="WHIT">                        </span><span class="NAME">fields.mnc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imsi.substring</span><span class="PUNC">(</span><span class="NUMB">3</span><span class="PUNC">,</span><span class="NUMB">6</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>527</span> </span><span class="WHIT">                        </span><span class="NAME">fields.msin</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imsi.substring</span><span class="PUNC">(</span><span class="NUMB">6</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>528</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>529</span> </span><span class="WHIT">                    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">fields</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>530</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>531</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>532</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>533</span> </span><span class="WHIT">            </span><span class="COMM">// non-transition character, continue parsing in the same state</span><span class="WHIT">
<span class='line'>534</span> </span><span class="WHIT">            </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>535</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>536</span> </span><span class="WHIT">            </span><span class="COMM">// should not happen</span><span class="WHIT">
<span class='line'>537</span> </span><span class="WHIT">            </span><span class="COMM">// console.info("skipping character " + ch);</span><span class="WHIT">
<span class='line'>538</span> </span><span class="WHIT">            </span><span class="COMM">// not a digit, plus, pound, or star, so this is probably a formatting char. Skip it.</span><span class="WHIT">
<span class='line'>539</span> </span><span class="WHIT">            </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>540</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>541</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>542</span> 
<span class='line'>543</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NAME">imsi.length</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">imsi.length</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">6</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>544</span> </span><span class="WHIT">        </span><span class="COMM">// we reached the end of the imsi, but did not finish recognizing anything.</span><span class="WHIT">
<span class='line'>545</span> </span><span class="WHIT">        </span><span class="COMM">// Default to last resort and assume 3 digit mnc</span><span class="WHIT">
<span class='line'>546</span> </span><span class="WHIT">        </span><span class="NAME">fields.mcc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imsi.substring</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NUMB">3</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>547</span> </span><span class="WHIT">        </span><span class="NAME">fields.mnc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imsi.substring</span><span class="PUNC">(</span><span class="NUMB">3</span><span class="PUNC">,</span><span class="NUMB">6</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>548</span> </span><span class="WHIT">        </span><span class="NAME">fields.msin</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imsi.substring</span><span class="PUNC">(</span><span class="NUMB">6</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>549</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>550</span> </span><span class="WHIT">        </span><span class="COMM">// unknown or not enough characters for a real imsi</span><span class="WHIT">
<span class='line'>551</span> </span><span class="WHIT">        </span><span class="NAME">fields</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>552</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>553</span> 
<span class='line'>554</span> </span><span class="WHIT">    </span><span class="COMM">// console.info("Globalization.Phone.parseImsi: final result is: " + JSON.stringify(fields));</span><span class="WHIT">
<span class='line'>555</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">fields</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>556</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>557</span> 
<span class='line'>558</span> </span><span class="COMM">/**
<span class='line'>559</span>  * @static
<span class='line'>560</span>  * @private
<span class='line'>561</span>  */</span><span class="WHIT">
<span class='line'>562</span> </span><span class="NAME">PhoneNumber._stripFormatting</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>563</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>564</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>565</span> 
<span class='line'>566</span> </span><span class="WHIT">    </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">str.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>567</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">PhoneNumber._getCharacterCode</span><span class="PUNC">(</span><span class="NAME">str.charAt</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>568</span> </span><span class="WHIT">            </span><span class="NAME">ret</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">str.charAt</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>569</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>570</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>571</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ret</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>572</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>573</span> 
<span class='line'>574</span> </span><span class="COMM">/**
<span class='line'>575</span>  * @static
<span class='line'>576</span>  * @protected
<span class='line'>577</span>  */</span><span class="WHIT">
<span class='line'>578</span> </span><span class="NAME">PhoneNumber._getCharacterCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">ch</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>579</span> </span><span class="WHIT">    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="STRN">'0'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="STRN">'9'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>580</span> </span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="STRN">'0'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>581</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>582</span> </span><span class="WHIT">    </span><span class="KEYW">switch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ch</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>583</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'+'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>584</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>585</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'*'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>586</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">11</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>587</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'#'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>588</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">12</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>589</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'^'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>590</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">13</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>591</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'p'</span><span class="PUNC">:</span><span class="WHIT">        </span><span class="COMM">// pause chars</span><span class="WHIT">
<span class='line'>592</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'P'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>593</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'t'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>594</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'T'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>595</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'w'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>596</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'W'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>597</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>598</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'x'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>599</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'X'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>600</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">','</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>601</span> </span><span class="WHIT">    </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">';'</span><span class="PUNC">:</span><span class="WHIT">        </span><span class="COMM">// extension char</span><span class="WHIT">
<span class='line'>602</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>603</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>604</span> </span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">2</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>605</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>606</span> 
<span class='line'>607</span> </span><span class="COMM">/**
<span class='line'>608</span>  * @private
<span class='line'>609</span>  */</span><span class="WHIT">
<span class='line'>610</span> </span><span class="NAME">PhoneNumber._states</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="WHIT">
<span class='line'>611</span> </span><span class="WHIT">    </span><span class="STRN">"none"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>612</span> </span><span class="WHIT">    </span><span class="STRN">"unknown"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>613</span> </span><span class="WHIT">    </span><span class="STRN">"plus"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>614</span> </span><span class="WHIT">    </span><span class="STRN">"idd"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>615</span> </span><span class="WHIT">    </span><span class="STRN">"cic"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>616</span> </span><span class="WHIT">    </span><span class="STRN">"service"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>617</span> </span><span class="WHIT">    </span><span class="STRN">"cell"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>618</span> </span><span class="WHIT">    </span><span class="STRN">"area"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>619</span> </span><span class="WHIT">    </span><span class="STRN">"vsc"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>620</span> </span><span class="WHIT">    </span><span class="STRN">"country"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>621</span> </span><span class="WHIT">    </span><span class="STRN">"personal"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>622</span> </span><span class="WHIT">    </span><span class="STRN">"special"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>623</span> </span><span class="WHIT">    </span><span class="STRN">"trunk"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>624</span> </span><span class="WHIT">    </span><span class="STRN">"premium"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>625</span> </span><span class="WHIT">    </span><span class="STRN">"emergency"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>626</span> </span><span class="WHIT">    </span><span class="STRN">"service2"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>627</span> </span><span class="WHIT">    </span><span class="STRN">"service3"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>628</span> </span><span class="WHIT">    </span><span class="STRN">"service4"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>629</span> </span><span class="WHIT">    </span><span class="STRN">"cic2"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>630</span> </span><span class="WHIT">    </span><span class="STRN">"cic3"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>631</span> </span><span class="WHIT">    </span><span class="STRN">"start"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>632</span> </span><span class="WHIT">    </span><span class="STRN">"local"</span><span class="WHIT">
<span class='line'>633</span> </span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>634</span> 
<span class='line'>635</span> </span><span class="COMM">/**
<span class='line'>636</span>  * @private
<span class='line'>637</span>  */</span><span class="WHIT">
<span class='line'>638</span> </span><span class="NAME">PhoneNumber._fieldOrder</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="WHIT">
<span class='line'>639</span> </span><span class="WHIT">    </span><span class="STRN">"vsc"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>640</span> </span><span class="WHIT">    </span><span class="STRN">"iddPrefix"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>641</span> </span><span class="WHIT">    </span><span class="STRN">"countryCode"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>642</span> </span><span class="WHIT">    </span><span class="STRN">"trunkAccess"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>643</span> </span><span class="WHIT">    </span><span class="STRN">"cic"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>644</span> </span><span class="WHIT">    </span><span class="STRN">"emergency"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>645</span> </span><span class="WHIT">    </span><span class="STRN">"mobilePrefix"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>646</span> </span><span class="WHIT">    </span><span class="STRN">"serviceCode"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>647</span> </span><span class="WHIT">    </span><span class="STRN">"areaCode"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>648</span> </span><span class="WHIT">    </span><span class="STRN">"subscriberNumber"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>649</span> </span><span class="WHIT">    </span><span class="STRN">"extension"</span><span class="WHIT">
<span class='line'>650</span> </span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>651</span> 
<span class='line'>652</span> </span><span class="NAME">PhoneNumber._defaultStates</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>653</span> </span><span class="WHIT">    </span><span class="STRN">"s"</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="WHIT">
<span class='line'>654</span> </span><span class="WHIT">        </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>655</span> </span><span class="WHIT">        </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// 1 -> local</span><span class="WHIT">
<span class='line'>656</span> </span><span class="WHIT">        </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// 2 -> local</span><span class="WHIT">
<span class='line'>657</span> </span><span class="WHIT">        </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// 3 -> local</span><span class="WHIT">
<span class='line'>658</span> </span><span class="WHIT">        </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// 4 -> local</span><span class="WHIT">
<span class='line'>659</span> </span><span class="WHIT">        </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// 5 -> local</span><span class="WHIT">
<span class='line'>660</span> </span><span class="WHIT">        </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// 6 -> local</span><span class="WHIT">
<span class='line'>661</span> </span><span class="WHIT">        </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// 7 -> local</span><span class="WHIT">
<span class='line'>662</span> </span><span class="WHIT">        </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// 8 -> local</span><span class="WHIT">
<span class='line'>663</span> </span><span class="WHIT">        </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// 9 -> local</span><span class="WHIT">
<span class='line'>664</span> </span><span class="WHIT">        </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>665</span> </span><span class="WHIT">        </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">// ^</span><span class="WHIT">
<span class='line'>666</span> </span><span class="WHIT">            </span><span class="STRN">"s"</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="WHIT">
<span class='line'>667</span> </span><span class="WHIT">                </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="COMM">// ^0</span><span class="WHIT">
<span class='line'>668</span> </span><span class="WHIT">                    </span><span class="STRN">"s"</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="COMM">// ^00 -> idd</span><span class="WHIT">
<span class='line'>669</span> </span><span class="WHIT">                    </span><span class="STRN">"l"</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NUMB">12</span><span class="WHIT">   </span><span class="COMM">// ^0  -> trunk</span><span class="WHIT">
<span class='line'>670</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>671</span> </span><span class="WHIT">                </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// ^1 -> local</span><span class="WHIT">
<span class='line'>672</span> </span><span class="WHIT">                </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// ^2 -> local</span><span class="WHIT">
<span class='line'>673</span> </span><span class="WHIT">                </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// ^3 -> local</span><span class="WHIT">
<span class='line'>674</span> </span><span class="WHIT">                </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// ^4 -> local</span><span class="WHIT">
<span class='line'>675</span> </span><span class="WHIT">                </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// ^5 -> local</span><span class="WHIT">
<span class='line'>676</span> </span><span class="WHIT">                </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// ^6 -> local</span><span class="WHIT">
<span class='line'>677</span> </span><span class="WHIT">                </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// ^7 -> local</span><span class="WHIT">
<span class='line'>678</span> </span><span class="WHIT">                </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// ^8 -> local</span><span class="WHIT">
<span class='line'>679</span> </span><span class="WHIT">                </span><span class="NUMB">21</span><span class="PUNC">,</span><span class="WHIT">  </span><span class="COMM">// ^9 -> local</span><span class="WHIT">
<span class='line'>680</span> </span><span class="WHIT">                </span><span class="NUMB">2</span><span class="WHIT">    </span><span class="COMM">// ^+ -> plus</span><span class="WHIT">
<span class='line'>681</span> </span><span class="WHIT">            </span><span class="PUNC">]</span><span class="WHIT">
<span class='line'>682</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>683</span> </span><span class="WHIT">    </span><span class="PUNC">]</span><span class="WHIT">
<span class='line'>684</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>685</span> 
<span class='line'>686</span> </span><span class="NAME">PhoneNumber.prototype</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>687</span> </span><span class="WHIT">    </span><span class="COMM">/**
<span class='line'>688</span>      * @protected
<span class='line'>689</span>      * @param {string} number
<span class='line'>690</span>      * @param {Object} regionData
<span class='line'>691</span>      * @param {Object} options
<span class='line'>692</span>      * @param {string} countryCode
<span class='line'>693</span>      */</span><span class="WHIT">
<span class='line'>694</span> </span><span class="WHIT">    </span><span class="NAME">_parseOtherCountry</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">number</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionData</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">countryCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>695</span> </span><span class="WHIT">        </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">PhoneLocale</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>696</span> </span><span class="WHIT">            </span><span class="NAME">locale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.locale</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>697</span> </span><span class="WHIT">            </span><span class="NAME">countryCode</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">countryCode</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>698</span> </span><span class="WHIT">            </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>699</span> </span><span class="WHIT">            </span><span class="NAME">loadParms</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.loadParams</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>700</span> </span><span class="WHIT">            </span><span class="NAME">onLoad</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">loc</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>701</span> </span><span class="WHIT">                </span><span class="COMM">/*
<span class='line'>702</span>                  * this.locale is the locale where this number is being parsed,
<span class='line'>703</span>                  * and is used to parse the IDD prefix, if any, and this.destinationLocale is
<span class='line'>704</span>                  * the locale of the rest of this number after the IDD prefix.
<span class='line'>705</span>                  */</span><span class="WHIT">
<span class='line'>706</span> </span><span class="WHIT">                </span><span class="COMM">/** @type {PhoneLocale} */</span><span class="WHIT">
<span class='line'>707</span> </span><span class="WHIT">                </span><span class="NAME">this.destinationLocale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">loc</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>708</span> 
<span class='line'>709</span> </span><span class="WHIT">                </span><span class="NAME">Utils.loadData</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>710</span> </span><span class="WHIT">                    </span><span class="NAME">name</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"states.json"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>711</span> </span><span class="WHIT">                    </span><span class="NAME">object</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"PhoneNumber"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>712</span> </span><span class="WHIT">                    </span><span class="NAME">locale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.destinationLocale</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>713</span> </span><span class="WHIT">                    </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>714</span> </span><span class="WHIT">                    </span><span class="NAME">loadParams</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">JSUtils.merge</span><span class="PUNC">(</span><span class="NAME">this.loadParams</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>715</span> </span><span class="WHIT">                        </span><span class="NAME">returnOne</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT">
<span class='line'>716</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>717</span> </span><span class="WHIT">                    </span><span class="NAME">callback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">stateData</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>718</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">stateData</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>719</span> </span><span class="WHIT">                            </span><span class="NAME">stateData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._defaultStates</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>720</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>721</span> 
<span class='line'>722</span> </span><span class="WHIT">                        </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">NumberingPlan</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>723</span> </span><span class="WHIT">                            </span><span class="NAME">locale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.destinationLocale</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>724</span> </span><span class="WHIT">                            </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>725</span> </span><span class="WHIT">                            </span><span class="NAME">loadParms</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.loadParams</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>726</span> </span><span class="WHIT">                            </span><span class="NAME">onLoad</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">plan</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>727</span> </span><span class="WHIT">                                </span><span class="COMM">/*
<span class='line'>728</span>                                  * this.plan is the plan where this number is being parsed,
<span class='line'>729</span>                                  * and is used to parse the IDD prefix, if any, and this.destinationPlan is
<span class='line'>730</span>                                  * the plan of the rest of this number after the IDD prefix in the
<span class='line'>731</span>                                  * destination locale.
<span class='line'>732</span>                                  */</span><span class="WHIT">
<span class='line'>733</span> </span><span class="WHIT">                                </span><span class="COMM">/** @type {NumberingPlan} */</span><span class="WHIT">
<span class='line'>734</span> </span><span class="WHIT">                                </span><span class="NAME">this.destinationPlan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">plan</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>735</span> 
<span class='line'>736</span> </span><span class="WHIT">                                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">regionSettings</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>737</span> </span><span class="WHIT">                                    </span><span class="NAME">stateData</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">stateData</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>738</span> </span><span class="WHIT">                                    </span><span class="NAME">plan</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">plan</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>739</span> </span><span class="WHIT">                                    </span><span class="NAME">handler</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">PhoneHandlerFactory</span><span class="PUNC">(</span><span class="NAME">this.destinationLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">plan</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>740</span> </span><span class="WHIT">                                </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>741</span> 
<span class='line'>742</span> </span><span class="WHIT">                                </span><span class="COMM">// for plans that do not skip the trunk code when dialing from</span><span class="WHIT">
<span class='line'>743</span> </span><span class="WHIT">                                </span><span class="COMM">// abroad, we need to treat the number from here on in as if it</span><span class="WHIT">
<span class='line'>744</span> </span><span class="WHIT">                                </span><span class="COMM">// were parsing a local number from scratch. That way, the parser</span><span class="WHIT">
<span class='line'>745</span> </span><span class="WHIT">                                </span><span class="COMM">// does not get confused between parts of the number at the</span><span class="WHIT">
<span class='line'>746</span> </span><span class="WHIT">                                </span><span class="COMM">// beginning of the number, and parts in the middle.</span><span class="WHIT">
<span class='line'>747</span> </span><span class="WHIT">                                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">plan.getSkipTrunk</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>748</span> </span><span class="WHIT">                                    </span><span class="NAME">number</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'^'</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">number</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>749</span> </span><span class="WHIT">                                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>750</span> 
<span class='line'>751</span> </span><span class="WHIT">                                </span><span class="COMM">// recursively call the parser with the new states data</span><span class="WHIT">
<span class='line'>752</span> </span><span class="WHIT">                                </span><span class="COMM">// to finish the parsing</span><span class="WHIT">
<span class='line'>753</span> </span><span class="WHIT">                                </span><span class="NAME">this._parseNumber</span><span class="PUNC">(</span><span class="NAME">number</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionSettings</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>754</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>755</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>756</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>757</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>758</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>759</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>760</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>761</span> 
<span class='line'>762</span> </span><span class="WHIT">    </span><span class="COMM">/**
<span class='line'>763</span>      * @protected
<span class='line'>764</span>      * @param {string} number
<span class='line'>765</span>      * @param {Object} regionData
<span class='line'>766</span>      * @param {Object} options
<span class='line'>767</span>      */</span><span class="WHIT">
<span class='line'>768</span> </span><span class="WHIT">    </span><span class="NAME">_parseNumber</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">number</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionData</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>769</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ch</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>770</span> </span><span class="WHIT">            </span><span class="NAME">regionSettings</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>771</span> </span><span class="WHIT">            </span><span class="NAME">newState</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>772</span> </span><span class="WHIT">            </span><span class="NAME">dot</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>773</span> </span><span class="WHIT">            </span><span class="NAME">handlerMethod</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>774</span> </span><span class="WHIT">            </span><span class="NAME">result</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>775</span> </span><span class="WHIT">            </span><span class="NAME">currentState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">regionData.stateData</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>776</span> </span><span class="WHIT">            </span><span class="NAME">lastLeaf</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>777</span> </span><span class="WHIT">            </span><span class="NAME">consumed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>778</span> 
<span class='line'>779</span> </span><span class="WHIT">        </span><span class="NAME">regionSettings</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">regionData</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>780</span> </span><span class="WHIT">        </span><span class="NAME">dot</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">14</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// special transition which matches all characters. See AreaCodeTableMaker.java</span><span class="WHIT">
<span class='line'>781</span> 
<span class='line'>782</span> </span><span class="WHIT">        </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>783</span> </span><span class="WHIT">        </span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">number.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>784</span> </span><span class="WHIT">            </span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._getCharacterCode</span><span class="PUNC">(</span><span class="NAME">number.charAt</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>785</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>786</span> </span><span class="WHIT">                </span><span class="COMM">// newState = stateData.states[state][ch];</span><span class="WHIT">
<span class='line'>787</span> </span><span class="WHIT">                </span><span class="NAME">newState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentState.s</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentState.s</span><span class="PUNC">[</span><span class="NAME">ch</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>788</span> 
<span class='line'>789</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">newState</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentState.s</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentState.s</span><span class="PUNC">[</span><span class="NAME">dot</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>790</span> </span><span class="WHIT">                    </span><span class="NAME">newState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentState.s</span><span class="PUNC">[</span><span class="NAME">dot</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>791</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>792</span> 
<span class='line'>793</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'object'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">number.length</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>794</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState.l</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>795</span> </span><span class="WHIT">                        </span><span class="COMM">// this is a leaf node, so save that for later if needed</span><span class="WHIT">
<span class='line'>796</span> </span><span class="WHIT">                        </span><span class="NAME">lastLeaf</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newState</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>797</span> </span><span class="WHIT">                        </span><span class="NAME">consumed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>798</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>799</span> </span><span class="WHIT">                    </span><span class="COMM">// console.info("recognized digit " + ch + " continuing...");</span><span class="WHIT">
<span class='line'>800</span> </span><span class="WHIT">                    </span><span class="COMM">// recognized digit, so continue parsing</span><span class="WHIT">
<span class='line'>801</span> </span><span class="WHIT">                    </span><span class="NAME">currentState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newState</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>802</span> </span><span class="WHIT">                    </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>803</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>804</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">newState</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>805</span> </span><span class="WHIT">                        </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'object'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState.l</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>806</span> </span><span class="WHIT">                         </span><span class="NAME">lastLeaf</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>807</span> </span><span class="WHIT">                        </span><span class="COMM">// this is possibly a look-ahead and it didn't work...</span><span class="WHIT">
<span class='line'>808</span> </span><span class="WHIT">                        </span><span class="COMM">// so fall back to the last leaf and use that as the</span><span class="WHIT">
<span class='line'>809</span> </span><span class="WHIT">                        </span><span class="COMM">// final state</span><span class="WHIT">
<span class='line'>810</span> </span><span class="WHIT">                        </span><span class="NAME">newState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lastLeaf</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>811</span> </span><span class="WHIT">                        </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">consumed</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>812</span> </span><span class="WHIT">                        </span><span class="NAME">consumed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>813</span> </span><span class="WHIT">                        </span><span class="NAME">lastLeaf</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>814</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>815</span> 
<span class='line'>816</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'number'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>817</span> </span><span class="WHIT">                        </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'object'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState.l</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>818</span> </span><span class="WHIT">                        </span><span class="COMM">// final state</span><span class="WHIT">
<span class='line'>819</span> </span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">stateNumber</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'number'</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">newState</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">newState.l</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>820</span> </span><span class="WHIT">                        </span><span class="NAME">handlerMethod</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._states</span><span class="PUNC">[</span><span class="NAME">stateNumber</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>821</span> 
<span class='line'>822</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">number.charAt</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'^'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>823</span> </span><span class="WHIT">                            </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">regionSettings.handler</span><span class="PUNC">[</span><span class="NAME">handlerMethod</span><span class="PUNC">]</span><span class="PUNC">(</span><span class="NAME">number.slice</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionSettings</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>824</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>825</span> </span><span class="WHIT">                            </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">regionSettings.handler</span><span class="PUNC">[</span><span class="NAME">handlerMethod</span><span class="PUNC">]</span><span class="PUNC">(</span><span class="NAME">number</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionSettings</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>826</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>827</span> 
<span class='line'>828</span> </span><span class="WHIT">                        </span><span class="COMM">// reparse whatever is left</span><span class="WHIT">
<span class='line'>829</span> </span><span class="WHIT">                        </span><span class="NAME">number</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">result.number</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>830</span> </span><span class="WHIT">                        </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">consumed</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>831</span> </span><span class="WHIT">                        </span><span class="NAME">lastLeaf</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>832</span> 
<span class='line'>833</span> </span><span class="WHIT">                        </span><span class="COMM">//console.log("reparsing with new number: " +  number);</span><span class="WHIT">
<span class='line'>834</span> </span><span class="WHIT">                        </span><span class="NAME">currentState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">regionSettings.stateData</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>835</span> </span><span class="WHIT">                        </span><span class="COMM">// if the handler requested a special sub-table, use it for this round of parsing,</span><span class="WHIT">
<span class='line'>836</span> </span><span class="WHIT">                        </span><span class="COMM">// otherwise, set it back to the regular table to continue parsing</span><span class="WHIT">
<span class='line'>837</span> 
<span class='line'>838</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">result.countryCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>839</span> </span><span class="WHIT">                            </span><span class="NAME">this._parseOtherCountry</span><span class="PUNC">(</span><span class="NAME">number</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionData</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">result.countryCode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>840</span> </span><span class="WHIT">                            </span><span class="COMM">// don't process any further -- let the work be done in the onLoad callbacks</span><span class="WHIT">
<span class='line'>841</span> </span><span class="WHIT">                            </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>842</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">result.table</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>843</span> </span><span class="WHIT">                            </span><span class="NAME">Utils.loadData</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>844</span> </span><span class="WHIT">                                </span><span class="NAME">name</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">result.table</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">".json"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>845</span> </span><span class="WHIT">                                </span><span class="NAME">object</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"PhoneNumber"</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>846</span> </span><span class="WHIT">                                </span><span class="NAME">nonlocale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>847</span> </span><span class="WHIT">                                </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>848</span> </span><span class="WHIT">                                </span><span class="NAME">loadParams</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.loadParams</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>849</span> </span><span class="WHIT">                                </span><span class="NAME">callback</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">data</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>850</span> </span><span class="WHIT">                                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">data</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>851</span> </span><span class="WHIT">                                        </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._defaultStates</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>852</span> </span><span class="WHIT">                                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>853</span> 
<span class='line'>854</span> </span><span class="WHIT">                                    </span><span class="NAME">regionSettings</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>855</span> </span><span class="WHIT">                                        </span><span class="NAME">stateData</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">data</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>856</span> </span><span class="WHIT">                                        </span><span class="NAME">plan</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">regionSettings.plan</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>857</span> </span><span class="WHIT">                                        </span><span class="NAME">handler</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">regionSettings.handler</span><span class="WHIT">
<span class='line'>858</span> </span><span class="WHIT">                                    </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>859</span> 
<span class='line'>860</span> </span><span class="WHIT">                                    </span><span class="COMM">// recursively call the parser with the new states data</span><span class="WHIT">
<span class='line'>861</span> </span><span class="WHIT">                                    </span><span class="COMM">// to finish the parsing</span><span class="WHIT">
<span class='line'>862</span> </span><span class="WHIT">                                    </span><span class="NAME">this._parseNumber</span><span class="PUNC">(</span><span class="NAME">number</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionSettings</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">options</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>863</span> </span><span class="WHIT">                                </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>864</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>865</span> </span><span class="WHIT">                            </span><span class="COMM">// don't process any further -- let the work be done in the onLoad callbacks</span><span class="WHIT">
<span class='line'>866</span> </span><span class="WHIT">                            </span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>867</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">result.skipTrunk</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>868</span> </span><span class="WHIT">                            </span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._getCharacterCode</span><span class="PUNC">(</span><span class="NAME">regionSettings.plan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>869</span> </span><span class="WHIT">                            </span><span class="NAME">currentState</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentState.s</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentState.s</span><span class="PUNC">[</span><span class="NAME">ch</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>870</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>871</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>872</span> </span><span class="WHIT">                        </span><span class="NAME">handlerMethod</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">newState</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'number'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">"none"</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"local"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>873</span> </span><span class="WHIT">                        </span><span class="COMM">// failed parse. Either no last leaf to fall back to, or there was an explicit</span><span class="WHIT">
<span class='line'>874</span> </span><span class="WHIT">                        </span><span class="COMM">// zero in the table. Put everything else in the subscriberNumber field as the</span><span class="WHIT">
<span class='line'>875</span> </span><span class="WHIT">                        </span><span class="COMM">// default place</span><span class="WHIT">
<span class='line'>876</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">number.charAt</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'^'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>877</span> </span><span class="WHIT">                            </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">regionSettings.handler</span><span class="PUNC">[</span><span class="NAME">handlerMethod</span><span class="PUNC">]</span><span class="PUNC">(</span><span class="NAME">number.slice</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionSettings</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>878</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>879</span> </span><span class="WHIT">                            </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">regionSettings.handler</span><span class="PUNC">[</span><span class="NAME">handlerMethod</span><span class="PUNC">]</span><span class="PUNC">(</span><span class="NAME">number</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionSettings</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>880</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>881</span> </span><span class="WHIT">                        </span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>882</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>883</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>884</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ch</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>885</span> </span><span class="WHIT">                </span><span class="COMM">// non-transition character, continue parsing in the same state</span><span class="WHIT">
<span class='line'>886</span> </span><span class="WHIT">                </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>887</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>888</span> </span><span class="WHIT">                </span><span class="COMM">// should not happen</span><span class="WHIT">
<span class='line'>889</span> </span><span class="WHIT">                </span><span class="COMM">// console.info("skipping character " + ch);</span><span class="WHIT">
<span class='line'>890</span> </span><span class="WHIT">                </span><span class="COMM">// not a digit, plus, pound, or star, so this is probably a formatting char. Skip it.</span><span class="WHIT">
<span class='line'>891</span> </span><span class="WHIT">                </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>892</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>893</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>894</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NAME">number.length</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentState</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">regionData.stateData</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>895</span> </span><span class="WHIT">            </span><span class="NAME">handlerMethod</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">currentState.l</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">currentState</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">"none"</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"local"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>896</span> </span><span class="WHIT">            </span><span class="COMM">// we reached the end of the phone number, but did not finish recognizing anything.</span><span class="WHIT">
<span class='line'>897</span> </span><span class="WHIT">            </span><span class="COMM">// Default to last resort and put everything that is left into the subscriber number</span><span class="WHIT">
<span class='line'>898</span> </span><span class="WHIT">            </span><span class="COMM">//console.log("Reached end of number before parsing was complete. Using handler for method none.")</span><span class="WHIT">
<span class='line'>899</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">number.charAt</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'^'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>900</span> </span><span class="WHIT">                </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">regionSettings.handler</span><span class="PUNC">[</span><span class="NAME">handlerMethod</span><span class="PUNC">]</span><span class="PUNC">(</span><span class="NAME">number.slice</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionSettings</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>901</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>902</span> </span><span class="WHIT">                </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">regionSettings.handler</span><span class="PUNC">[</span><span class="NAME">handlerMethod</span><span class="PUNC">]</span><span class="PUNC">(</span><span class="NAME">number</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">regionSettings</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>903</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>904</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>905</span> 
<span class='line'>906</span> </span><span class="WHIT">        </span><span class="COMM">// let the caller know we are done parsing</span><span class="WHIT">
<span class='line'>907</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.onLoad</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>908</span> </span><span class="WHIT">            </span><span class="NAME">this.onLoad</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>909</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>910</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>911</span> </span><span class="WHIT">    </span><span class="COMM">/**
<span class='line'>912</span>      * @protected
<span class='line'>913</span>      */</span><span class="WHIT">
<span class='line'>914</span> </span><span class="WHIT">    </span><span class="NAME">_getPrefix</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>915</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.areaCode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.serviceCode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.mobilePrefix</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>916</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>917</span> 
<span class='line'>918</span> </span><span class="WHIT">    </span><span class="COMM">/**
<span class='line'>919</span>      * @protected
<span class='line'>920</span>      */</span><span class="WHIT">
<span class='line'>921</span> </span><span class="WHIT">    </span><span class="NAME">_hasPrefix</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>922</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this._getPrefix</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>923</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>924</span> 
<span class='line'>925</span> </span><span class="WHIT">    </span><span class="COMM">/**
<span class='line'>926</span>      * Exclusive or -- return true, if one is defined and the other isn't
<span class='line'>927</span>      * @protected
<span class='line'>928</span>      */</span><span class="WHIT">
<span class='line'>929</span> </span><span class="WHIT">    </span><span class="NAME">_xor</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">left</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">right</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>930</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">left</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">right</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">left</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">right</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>931</span> </span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>932</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>933</span> </span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>934</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>935</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>936</span> 
<span class='line'>937</span> </span><span class="WHIT">    </span><span class="COMM">/**
<span class='line'>938</span>      * return a version of the phone number that contains only the dialable digits in the correct order
<span class='line'>939</span>      * @protected
<span class='line'>940</span>      */</span><span class="WHIT">
<span class='line'>941</span> </span><span class="WHIT">    </span><span class="NAME">_join</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>942</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fieldName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">formatted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>943</span> 
<span class='line'>944</span> </span><span class="WHIT">        </span><span class="KEYW">try</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>945</span> </span><span class="WHIT">            </span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">field</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._fieldOrder</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>946</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">field</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'string'</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._fieldOrder</span><span class="PUNC">[</span><span class="NAME">field</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'string'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>947</span> </span><span class="WHIT">                    </span><span class="NAME">fieldName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._fieldOrder</span><span class="PUNC">[</span><span class="NAME">field</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>948</span> </span><span class="WHIT">                    </span><span class="COMM">// console.info("normalize: formatting field " + fieldName);</span><span class="WHIT">
<span class='line'>949</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">[</span><span class="NAME">fieldName</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>950</span> </span><span class="WHIT">                        </span><span class="NAME">formatted</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">[</span><span class="NAME">fieldName</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>951</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>952</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>953</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>954</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">catch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">e</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>955</span> </span><span class="WHIT">            </span><span class="COMM">//console.warn("caught exception in _join: " + e);</span><span class="WHIT">
<span class='line'>956</span> </span><span class="WHIT">            </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="NAME">e</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>957</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>958</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">formatted</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>959</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>960</span> 
<span class='line'>961</span> </span><span class="WHIT">    </span><span class="COMM">/**
<span class='line'>962</span>      * This routine will compare the two phone numbers in an locale-sensitive
<span class='line'>963</span>      * manner to see if they possibly reference the same phone number.&lt;p>
<span class='line'>964</span>      *
<span class='line'>965</span>      * In many places,
<span class='line'>966</span>      * there are multiple ways to reach the same phone number. In North America for
<span class='line'>967</span>      * example, you might have a number with the trunk access code of "1" and another
<span class='line'>968</span>      * without, and they reference the exact same phone number. This is considered a
<span class='line'>969</span>      * strong match. For a different pair of numbers, one may be a local number and
<span class='line'>970</span>      * the other a full phone number with area code, which may reference the same
<span class='line'>971</span>      * phone number if the local number happens to be located in that area code.
<span class='line'>972</span>      * However, you cannot say for sure if it is in that area code, so it will
<span class='line'>973</span>      * be considered a somewhat weaker match.&lt;p>
<span class='line'>974</span>      *
<span class='line'>975</span>      * Similarly, in other countries, there are sometimes different ways of
<span class='line'>976</span>      * reaching the same destination, and the way that numbers
<span class='line'>977</span>      * match depends on the locale.&lt;p>
<span class='line'>978</span>      *
<span class='line'>979</span>      * The various phone number fields are handled differently for matches. There
<span class='line'>980</span>      * are various fields that do not need to match at all. For example, you may
<span class='line'>981</span>      * type equally enter "00" or "+" into your phone to start international direct
<span class='line'>982</span>      * dialling, so the iddPrefix field does not need to match at all.&lt;p>
<span class='line'>983</span>      *
<span class='line'>984</span>      * Typically, fields that require matches need to match exactly if both sides have a value
<span class='line'>985</span>      * for that field. If both sides specify a value and those values differ, that is
<span class='line'>986</span>      * a strong non-match. If one side does not have a value and the other does, that
<span class='line'>987</span>      * causes a partial match, because the number with the missing field may possibly
<span class='line'>988</span>      * have an implied value that matches the other number. For example, the numbers
<span class='line'>989</span>      * "650-555-1234" and "555-1234" have a partial match as the local number "555-1234"
<span class='line'>990</span>      * might possibly have the same 650 area code as the first number, and might possibly
<span class='line'>991</span>      * not. If both side do not specify a value for a particular field, that field is
<span class='line'>992</span>      * considered matching.&lt;p>
<span class='line'>993</span>      *
<span class='line'>994</span>      * The values of following fields are ignored when performing matches:
<span class='line'>995</span>      *
<span class='line'>996</span>      * &lt;ul>
<span class='line'>997</span>      * &lt;li>vsc
<span class='line'>998</span>      * &lt;li>iddPrefix
<span class='line'>999</span>      * &lt;li>cic
<span class='line'>1000</span>      * &lt;li>trunkAccess
<span class='line'>1001</span>      * &lt;/ul>
<span class='line'>1002</span>      *
<span class='line'>1003</span>      * The values of the following fields matter if they do not match:
<span class='line'>1004</span>      *
<span class='line'>1005</span>      * &lt;ul>
<span class='line'>1006</span>      * &lt;li>countryCode - A difference causes a moderately strong problem except for
<span class='line'>1007</span>      * certain countries where there is a way to access the same subscriber via IDD
<span class='line'>1008</span>      * and via intranetwork dialling
<span class='line'>1009</span>      * &lt;li>mobilePrefix - A difference causes a possible non-match
<span class='line'>1010</span>      * &lt;li>serviceCode - A difference causes a possible non-match
<span class='line'>1011</span>      * &lt;li>areaCode - A difference causes a possible non-match
<span class='line'>1012</span>      * &lt;li>subscriberNumber - A difference causes a very strong non-match
<span class='line'>1013</span>      * &lt;li>extension - A difference causes a minor non-match
<span class='line'>1014</span>      * &lt;/ul>
<span class='line'>1015</span>      *
<span class='line'>1016</span>      * @param {string|PhoneNumber} other other phone number to compare this one to
<span class='line'>1017</span>      * @return {number} non-negative integer describing the percentage quality of the
<span class='line'>1018</span>      * match. 100 means a very strong match (100%), and lower numbers are less and
<span class='line'>1019</span>      * less strong, down to 0 meaning not at all a match.
<span class='line'>1020</span>      */</span><span class="WHIT">
<span class='line'>1021</span> </span><span class="WHIT">    </span><span class="NAME">compare</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">other</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1022</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1023</span> </span><span class="WHIT">            </span><span class="NAME">FRdepartments</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="STRN">"590"</span><span class="PUNC">:</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"594"</span><span class="PUNC">:</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"596"</span><span class="PUNC">:</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"262"</span><span class="PUNC">:</span><span class="NUMB">1</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1024</span> </span><span class="WHIT">            </span><span class="NAME">ITcountries</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="STRN">"378"</span><span class="PUNC">:</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"379"</span><span class="PUNC">:</span><span class="NUMB">1</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1025</span> </span><span class="WHIT">            </span><span class="NAME">thisPrefix</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1026</span> </span><span class="WHIT">            </span><span class="NAME">otherPrefix</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1027</span> </span><span class="WHIT">            </span><span class="NAME">currentCountryCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1028</span> 
<span class='line'>1029</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="WHIT"> </span><span class="NAME">this.locale.region</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"string"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1030</span> </span><span class="WHIT">            </span><span class="NAME">currentCountryCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.locale._mapRegiontoCC</span><span class="PUNC">(</span><span class="NAME">this.locale.region</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1031</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1032</span> 
<span class='line'>1033</span> </span><span class="WHIT">        </span><span class="COMM">// subscriber number must be present and must match</span><span class="WHIT">
<span class='line'>1034</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.subscriberNumber</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">other.subscriberNumber</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.subscriberNumber</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.subscriberNumber</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1035</span> </span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1036</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1037</span> 
<span class='line'>1038</span> </span><span class="WHIT">        </span><span class="COMM">// extension must match if it is present</span><span class="WHIT">
<span class='line'>1039</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this._xor</span><span class="PUNC">(</span><span class="NAME">this.extension</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">other.extension</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.extension</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.extension</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1040</span> </span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1041</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1042</span> 
<span class='line'>1043</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this._xor</span><span class="PUNC">(</span><span class="NAME">this.countryCode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">other.countryCode</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1044</span> </span><span class="WHIT">            </span><span class="COMM">// if one doesn't have a country code, give it some demerit points, but if the</span><span class="WHIT">
<span class='line'>1045</span> </span><span class="WHIT">            </span><span class="COMM">// one that has the country code has something other than the current country</span><span class="WHIT">
<span class='line'>1046</span> </span><span class="WHIT">            </span><span class="COMM">// add even more. Ignore the special cases where you can dial the same number internationally or via</span><span class="WHIT">
<span class='line'>1047</span> </span><span class="WHIT">            </span><span class="COMM">// the local numbering system</span><span class="WHIT">
<span class='line'>1048</span> </span><span class="WHIT">            </span><span class="KEYW">switch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.locale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1049</span> </span><span class="WHIT">            </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'FR'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>1050</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.countryCode</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">FRdepartments</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">other.countryCode</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">FRdepartments</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1051</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.areaCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.areaCode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.mobilePrefix</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.mobilePrefix</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1052</span> </span><span class="WHIT">                        </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1053</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1054</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1055</span> </span><span class="WHIT">                    </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">16</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1056</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1057</span> </span><span class="WHIT">                </span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1058</span> </span><span class="WHIT">            </span><span class="KEYW">case</span><span class="WHIT"> </span><span class="STRN">'IT'</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>1059</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.countryCode</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">ITcountries</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">other.countryCode</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">ITcountries</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1060</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.areaCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.areaCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1061</span> </span><span class="WHIT">                        </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1062</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1063</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1064</span> </span><span class="WHIT">                    </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">16</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1065</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1066</span> </span><span class="WHIT">                </span><span class="KEYW">break</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1067</span> </span><span class="WHIT">            </span><span class="KEYW">default</span><span class="PUNC">:</span><span class="WHIT">
<span class='line'>1068</span> </span><span class="WHIT">                </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">16</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1069</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">this.countryCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.countryCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">currentCountryCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>1070</span> </span><span class="WHIT">                    </span><span class="PUNC">(</span><span class="NAME">other.countryCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">undefined</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">other.countryCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">currentCountryCode</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1071</span> </span><span class="WHIT">                    </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">16</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1072</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1073</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1074</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.countryCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.countryCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1075</span> </span><span class="WHIT">            </span><span class="COMM">// ignore the special cases where you can dial the same number internationally or via</span><span class="WHIT">
<span class='line'>1076</span> </span><span class="WHIT">            </span><span class="COMM">// the local numbering system</span><span class="WHIT">
<span class='line'>1077</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">other.countryCode</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'33'</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.countryCode</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'33'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1078</span> </span><span class="WHIT">                </span><span class="COMM">// france</span><span class="WHIT">
<span class='line'>1079</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.countryCode</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">FRdepartments</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">other.countryCode</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">FRdepartments</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1080</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.areaCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.areaCode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.mobilePrefix</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.mobilePrefix</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1081</span> </span><span class="WHIT">                        </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1082</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1083</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1084</span> </span><span class="WHIT">                    </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1085</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1086</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.countryCode</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'39'</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">other.countryCode</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'39'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1087</span> </span><span class="WHIT">                </span><span class="COMM">// italy</span><span class="WHIT">
<span class='line'>1088</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.countryCode</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">ITcountries</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">other.countryCode</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">ITcountries</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1089</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.areaCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.areaCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1090</span> </span><span class="WHIT">                        </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1091</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1092</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1093</span> </span><span class="WHIT">                    </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1094</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1095</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1096</span> </span><span class="WHIT">                </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1097</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1098</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1099</span> 
<span class='line'>1100</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this._xor</span><span class="PUNC">(</span><span class="NAME">this.serviceCode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">other.serviceCode</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1101</span> </span><span class="WHIT">            </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">20</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1102</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.serviceCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.serviceCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1103</span> </span><span class="WHIT">            </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1104</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1105</span> 
<span class='line'>1106</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this._xor</span><span class="PUNC">(</span><span class="NAME">this.mobilePrefix</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">other.mobilePrefix</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1107</span> </span><span class="WHIT">            </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">20</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1108</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mobilePrefix</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.mobilePrefix</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1109</span> </span><span class="WHIT">            </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1110</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1111</span> 
<span class='line'>1112</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this._xor</span><span class="PUNC">(</span><span class="NAME">this.areaCode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">other.areaCode</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1113</span> </span><span class="WHIT">            </span><span class="COMM">// one has an area code, the other doesn't, so dock some points. It could be a match if the local</span><span class="WHIT">
<span class='line'>1114</span> </span><span class="WHIT">            </span><span class="COMM">// number in the one number has the same implied area code as the explicit area code in the other number.</span><span class="WHIT">
<span class='line'>1115</span> </span><span class="WHIT">            </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">12</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1116</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.areaCode</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">other.areaCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1117</span> </span><span class="WHIT">            </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1118</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1119</span> 
<span class='line'>1120</span> </span><span class="WHIT">        </span><span class="NAME">thisPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._getPrefix</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1121</span> </span><span class="WHIT">        </span><span class="NAME">otherPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">other._getPrefix</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1122</span> 
<span class='line'>1123</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">thisPrefix</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">otherPrefix</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">thisPrefix</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">otherPrefix</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1124</span> </span><span class="WHIT">            </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1125</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1126</span> 
<span class='line'>1127</span> </span><span class="WHIT">        </span><span class="COMM">// make sure we are between 0 and 100</span><span class="WHIT">
<span class='line'>1128</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1129</span> </span><span class="WHIT">            </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1130</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1131</span> </span><span class="WHIT">            </span><span class="NAME">match</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1132</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1133</span> 
<span class='line'>1134</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">match</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1135</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1136</span> 
<span class='line'>1137</span> </span><span class="WHIT">    </span><span class="COMM">/**
<span class='line'>1138</span>      * Determine whether or not the other phone number is exactly equal to the current one.&lt;p>
<span class='line'>1139</span>      *
<span class='line'>1140</span>      * The difference between the compare method and the equals method is that the compare
<span class='line'>1141</span>      * method compares normalized numbers with each other and returns the degree of match,
<span class='line'>1142</span>      * whereas the equals operator returns true iff the two numbers contain the same fields
<span class='line'>1143</span>      * and the fields are exactly the same. Functions and other non-phone number properties
<span class='line'>1144</span>      * are not compared.
<span class='line'>1145</span>      * @param {string|PhoneNumber} other another phone number to compare to this one
<span class='line'>1146</span>      * @return {boolean} true if the numbers are the same, false otherwise
<span class='line'>1147</span>      */</span><span class="WHIT">
<span class='line'>1148</span> </span><span class="WHIT">    </span><span class="NAME">equals</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">equals</span><span class="PUNC">(</span><span class="NAME">other</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1149</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">other.locale</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.locale</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">this.locale.equals</span><span class="PUNC">(</span><span class="NAME">other.locale</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.countryCode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">other.countryCode</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1150</span> </span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1151</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1152</span> 
<span class='line'>1153</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">_this</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1154</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">PhoneNumber._fieldOrder.every</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">field</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1155</span> </span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">_this</span><span class="PUNC">[</span><span class="NAME">field</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">other</span><span class="PUNC">[</span><span class="NAME">field</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1156</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1157</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1158</span> 
<span class='line'>1159</span> </span><span class="WHIT">    </span><span class="COMM">/**
<span class='line'>1160</span>      * @private
<span class='line'>1161</span>      * @param {{
<span class='line'>1162</span>      *   mcc:string,
<span class='line'>1163</span>      *   defaultAreaCode:string,
<span class='line'>1164</span>      *   country:string,
<span class='line'>1165</span>      *   networkType:string,
<span class='line'>1166</span>      *   assistedDialing:boolean,
<span class='line'>1167</span>      *   sms:boolean,
<span class='line'>1168</span>      *   manualDialing:boolean
<span class='line'>1169</span>      * }} options an object containing options to help in normalizing.
<span class='line'>1170</span>      * @param {PhoneNumber} norm
<span class='line'>1171</span>      * @param {PhoneLocale} homeLocale
<span class='line'>1172</span>      * @param {PhoneLocale} currentLocale
<span class='line'>1173</span>      * @param {NumberingPlan} currentPlan
<span class='line'>1174</span>      * @param {PhoneLocale} destinationLocale
<span class='line'>1175</span>      * @param {NumberingPlan} destinationPlan
<span class='line'>1176</span>      * @param {boolean} sync
<span class='line'>1177</span>      * @param {Object|undefined} loadParams
<span class='line'>1178</span>      */</span><span class="WHIT">
<span class='line'>1179</span> </span><span class="WHIT">    </span><span class="NAME">_doNormalize</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">norm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">homeLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">currentLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">currentPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">destinationLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">destinationPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1180</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">formatted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1181</span> 
<span class='line'>1182</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">norm.invalid</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">options.assistedDialing</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1183</span> </span><span class="WHIT">            </span><span class="COMM">// don't normalize things that don't have subscriber numbers. Also, don't normalize</span><span class="WHIT">
<span class='line'>1184</span> </span><span class="WHIT">            </span><span class="COMM">// manually dialed local numbers. Do normalize local numbers in contact entries.</span><span class="WHIT">
<span class='line'>1185</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">norm.subscriberNumber</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1186</span> </span><span class="WHIT">                    </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">options.manualDialing</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>1187</span> </span><span class="WHIT">                     </span><span class="NAME">norm.iddPrefix</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>1188</span> </span><span class="WHIT">                     </span><span class="NAME">norm.countryCode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>1189</span> </span><span class="WHIT">                     </span><span class="NAME">norm.trunkAccess</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1190</span> </span><span class="WHIT">                </span><span class="COMM">// console.log("normalize: assisted dialling normalization of " + JSON.stringify(norm));</span><span class="WHIT">
<span class='line'>1191</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currentLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">destinationLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1192</span> </span><span class="WHIT">                    </span><span class="COMM">// we are currently calling internationally</span><span class="WHIT">
<span class='line'>1193</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">norm._hasPrefix</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1194</span> </span><span class="WHIT">                            </span><span class="NAME">options.defaultAreaCode</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1195</span> </span><span class="WHIT">                            </span><span class="NAME">destinationLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">homeLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1196</span> </span><span class="WHIT">                            </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">destinationPlan.getFieldLength</span><span class="PUNC">(</span><span class="STRN">"minLocalLength"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>1197</span> </span><span class="WHIT">                                </span><span class="NAME">norm.subscriberNumber.length</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getFieldLength</span><span class="PUNC">(</span><span class="STRN">"minLocalLength"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1198</span> </span><span class="WHIT">                        </span><span class="COMM">// area code is required when dialling from international, but only add it if we are dialing</span><span class="WHIT">
<span class='line'>1199</span> </span><span class="WHIT">                        </span><span class="COMM">// to our home area. Otherwise, the default area code is not valid!</span><span class="WHIT">
<span class='line'>1200</span> </span><span class="WHIT">                        </span><span class="NAME">norm.areaCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">options.defaultAreaCode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1201</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">destinationPlan.getSkipTrunk</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1202</span> </span><span class="WHIT">                            </span><span class="COMM">// some phone systems require the trunk access code, even when dialling from international</span><span class="WHIT">
<span class='line'>1203</span> </span><span class="WHIT">                            </span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1204</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1205</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1206</span> 
<span class='line'>1207</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getSkipTrunk</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1208</span> </span><span class="WHIT">                        </span><span class="COMM">// on some phone systems, the trunk access code is dropped when dialling from international</span><span class="WHIT">
<span class='line'>1209</span> </span><span class="WHIT">                        </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">norm.trunkAccess</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1210</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1211</span> 
<span class='line'>1212</span> </span><span class="WHIT">                    </span><span class="COMM">// make sure to get the country code for the destination region, not the current region!</span><span class="WHIT">
<span class='line'>1213</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options.sms</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1214</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">homeLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"US"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">"US"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1215</span> </span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">destinationLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">"US"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1216</span> </span><span class="WHIT">                                </span><span class="NAME">norm.iddPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"011"</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// non-standard code to make it go through the US first</span><span class="WHIT">
<span class='line'>1217</span> </span><span class="WHIT">                                </span><span class="NAME">norm.countryCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">norm.countryCode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">homeLocale._mapRegiontoCC</span><span class="PUNC">(</span><span class="NAME">destinationLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1218</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options.networkType</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"cdma"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1219</span> </span><span class="WHIT">                                </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">norm.iddPrefix</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1220</span> </span><span class="WHIT">                                </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">norm.countryCode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1221</span> </span><span class="WHIT">                                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">norm.areaCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1222</span> </span><span class="WHIT">                                    </span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"1"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1223</span> </span><span class="WHIT">                                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1224</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">norm.areaCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1225</span> </span><span class="WHIT">                                </span><span class="NAME">norm.iddPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"+"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1226</span> </span><span class="WHIT">                                </span><span class="NAME">norm.countryCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"1"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1227</span> </span><span class="WHIT">                                </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">norm.trunkAccess</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1228</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1229</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1230</span> </span><span class="WHIT">                            </span><span class="NAME">norm.iddPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options.networkType</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"cdma"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">currentPlan.getIDDCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"+"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1231</span> </span><span class="WHIT">                            </span><span class="NAME">norm.countryCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">norm.countryCode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">homeLocale._mapRegiontoCC</span><span class="PUNC">(</span><span class="NAME">destinationLocale.region</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1232</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1233</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">norm._hasPrefix</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">norm.countryCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1234</span> </span><span class="WHIT">                        </span><span class="NAME">norm.countryCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">homeLocale._mapRegiontoCC</span><span class="PUNC">(</span><span class="NAME">destinationLocale.region</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1235</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1236</span> 
<span class='line'>1237</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">norm.countryCode</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">options.sms</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1238</span> </span><span class="WHIT">                        </span><span class="COMM">// for CDMA, make sure to get the international dialling access code for the current region, not the destination region</span><span class="WHIT">
<span class='line'>1239</span> </span><span class="WHIT">                        </span><span class="COMM">// all umts carriers support plus dialing</span><span class="WHIT">
<span class='line'>1240</span> </span><span class="WHIT">                        </span><span class="NAME">norm.iddPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options.networkType</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"cdma"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">currentPlan.getIDDCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="STRN">"+"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1241</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1242</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1243</span> </span><span class="WHIT">                    </span><span class="COMM">// console.log("normalize: dialing within the country");</span><span class="WHIT">
<span class='line'>1244</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options.defaultAreaCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1245</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">destinationPlan.getPlanStyle</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"open"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1246</span> </span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">norm._hasPrefix</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1247</span> </span><span class="WHIT">                                </span><span class="COMM">// call is not local to this area code, so you have to dial the trunk code and the area code</span><span class="WHIT">
<span class='line'>1248</span> </span><span class="WHIT">                                </span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1249</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1250</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1251</span> </span><span class="WHIT">                            </span><span class="COMM">// In closed plans, you always have to dial the area code, even if the call is local.</span><span class="WHIT">
<span class='line'>1252</span> </span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">norm._hasPrefix</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1253</span> </span><span class="WHIT">                                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">destinationLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">homeLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1254</span> </span><span class="WHIT">                                    </span><span class="NAME">norm.areaCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">options.defaultAreaCode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1255</span> </span><span class="WHIT">                                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">destinationPlan.getTrunkRequired</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1256</span> </span><span class="WHIT">                                        </span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1257</span> </span><span class="WHIT">                                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1258</span> </span><span class="WHIT">                                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1259</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1260</span> </span><span class="WHIT">                                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">destinationPlan.getTrunkRequired</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1261</span> </span><span class="WHIT">                                    </span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1262</span> </span><span class="WHIT">                                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1263</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1264</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1265</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1266</span> 
<span class='line'>1267</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options.sms</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1268</span> </span><span class="WHIT">                            </span><span class="NAME">homeLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"US"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1269</span> </span><span class="WHIT">                            </span><span class="NAME">currentLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">"US"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1270</span> </span><span class="WHIT">                        </span><span class="NAME">norm.iddPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"011"</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// make it go through the US first</span><span class="WHIT">
<span class='line'>1271</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">destinationPlan.getSkipTrunk</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">norm.trunkAccess</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1272</span> </span><span class="WHIT">                            </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">norm.trunkAccess</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1273</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1274</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">norm.iddPrefix</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">norm.countryCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1275</span> </span><span class="WHIT">                        </span><span class="COMM">// we are in our destination country, so strip the international dialling prefixes</span><span class="WHIT">
<span class='line'>1276</span> </span><span class="WHIT">                        </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">norm.iddPrefix</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1277</span> </span><span class="WHIT">                        </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">norm.countryCode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1278</span> 
<span class='line'>1279</span> </span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">destinationPlan.getPlanStyle</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"open"</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkRequired</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1280</span> </span><span class="WHIT">                            </span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1281</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1282</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1283</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1284</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1285</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">norm.invalid</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1286</span> </span><span class="WHIT">            </span><span class="COMM">// console.log("normalize: non-assisted normalization");</span><span class="WHIT">
<span class='line'>1287</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">norm._hasPrefix</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">options.defaultAreaCode</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">destinationLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="NAME">homeLocale.region</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1288</span> </span><span class="WHIT">                </span><span class="NAME">norm.areaCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">options.defaultAreaCode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1289</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1290</span> 
<span class='line'>1291</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">norm.countryCode</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">norm._hasPrefix</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1292</span> </span><span class="WHIT">                </span><span class="NAME">norm.countryCode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">homeLocale._mapRegiontoCC</span><span class="PUNC">(</span><span class="NAME">destinationLocale.getRegion</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1293</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1294</span> 
<span class='line'>1295</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">norm.countryCode</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1296</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">options.networkType</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">options.networkType</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">"cdma"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1297</span> </span><span class="WHIT">                    </span><span class="NAME">norm.iddPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">currentPlan.getIDDCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1298</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1299</span> </span><span class="WHIT">                    </span><span class="COMM">// all umts carriers support plus dialing</span><span class="WHIT">
<span class='line'>1300</span> </span><span class="WHIT">                    </span><span class="NAME">norm.iddPrefix</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"+"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1301</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1302</span> 
<span class='line'>1303</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">destinationPlan.getSkipTrunk</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">norm.trunkAccess</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1304</span> </span><span class="WHIT">                    </span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">norm.trunkAccess</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1305</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">destinationPlan.getSkipTrunk</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1306</span> </span><span class="WHIT">                    </span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">destinationPlan.getTrunkCode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1307</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1308</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1309</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1310</span> 
<span class='line'>1311</span> </span><span class="WHIT">        </span><span class="COMM">// console.info("normalize: after normalization, the normalized phone number is: " + JSON.stringify(norm));</span><span class="WHIT">
<span class='line'>1312</span> </span><span class="WHIT">        </span><span class="NAME">formatted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">norm._join</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1313</span> 
<span class='line'>1314</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">formatted</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1315</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1316</span> 
<span class='line'>1317</span> </span><span class="WHIT">    </span><span class="COMM">/**
<span class='line'>1318</span>      * @private
<span class='line'>1319</span>      * @param {{
<span class='line'>1320</span>      *   mcc:string,
<span class='line'>1321</span>      *   defaultAreaCode:string,
<span class='line'>1322</span>      *   country:string,
<span class='line'>1323</span>      *   networkType:string,
<span class='line'>1324</span>      *   assistedDialing:boolean,
<span class='line'>1325</span>      *   sms:boolean,
<span class='line'>1326</span>      *   manualDialing:boolean
<span class='line'>1327</span>      * }} options an object containing options to help in normalizing.
<span class='line'>1328</span>      * @param {PhoneNumber} norm
<span class='line'>1329</span>      * @param {PhoneLocale} homeLocale
<span class='line'>1330</span>      * @param {PhoneLocale} currentLocale
<span class='line'>1331</span>      * @param {NumberingPlan} currentPlan
<span class='line'>1332</span>      * @param {PhoneLocale} destinationLocale
<span class='line'>1333</span>      * @param {NumberingPlan} destinationPlan
<span class='line'>1334</span>      * @param {boolean} sync
<span class='line'>1335</span>      * @param {Object|undefined} loadParams
<span class='line'>1336</span>      * @param {function(string)} callback
<span class='line'>1337</span>      */</span><span class="WHIT">
<span class='line'>1338</span> </span><span class="WHIT">    </span><span class="NAME">_doReparse</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">norm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">homeLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">currentLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">currentPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">destinationLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">destinationPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1339</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">formatted</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1340</span> </span><span class="WHIT">            </span><span class="NAME">tempRegion</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1341</span> 
<span class='line'>1342</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1343</span> </span><span class="WHIT">                </span><span class="NAME">options.assistedDialing</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1344</span> </span><span class="WHIT">                </span><span class="PUNC">!</span><span class="NAME">norm.trunkAccess</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1345</span> </span><span class="WHIT">                </span><span class="PUNC">!</span><span class="NAME">norm.iddPrefix</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1346</span> </span><span class="WHIT">                </span><span class="NAME">norm.subscriberNumber</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT">
<span class='line'>1347</span> </span><span class="WHIT">                </span><span class="NAME">norm.subscriberNumber.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">destinationPlan.getFieldLength</span><span class="PUNC">(</span><span class="STRN">"maxLocalLength"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1348</span> 
<span class='line'>1349</span> </span><span class="WHIT">            </span><span class="COMM">// numbers that are too long are sometimes international direct dialed numbers that</span><span class="WHIT">
<span class='line'>1350</span> </span><span class="WHIT">            </span><span class="COMM">// are missing the IDD prefix. So, try reparsing it using a plus in front to see if that works.</span><span class="WHIT">
<span class='line'>1351</span> </span><span class="WHIT">            </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">PhoneNumber</span><span class="PUNC">(</span><span class="STRN">"+"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this._join</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1352</span> </span><span class="WHIT">                </span><span class="NAME">locale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.locale</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1353</span> </span><span class="WHIT">                </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1354</span> </span><span class="WHIT">                </span><span class="NAME">loadParms</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1355</span> </span><span class="WHIT">                </span><span class="NAME">onLoad</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">data</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1356</span> </span><span class="WHIT">                    </span><span class="NAME">tempRegion</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">data.countryCode</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">data.locale._mapCCtoRegion</span><span class="PUNC">(</span><span class="NAME">data.countryCode</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1357</span> 
<span class='line'>1358</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">tempRegion</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">tempRegion</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">"unknown"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">tempRegion</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">"SG"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1359</span> </span><span class="WHIT">                        </span><span class="COMM">// only use it if it is a recognized country code. Singapore (SG) is a special case.</span><span class="WHIT">
<span class='line'>1360</span> </span><span class="WHIT">                        </span><span class="NAME">norm</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">data</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1361</span> </span><span class="WHIT">                        </span><span class="NAME">destinationLocale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">data.destinationLocale</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1362</span> </span><span class="WHIT">                        </span><span class="NAME">destinationPlan</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">data.destinationPlan</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1363</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1364</span> 
<span class='line'>1365</span> </span><span class="WHIT">                    </span><span class="NAME">formatted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._doNormalize</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">norm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">homeLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">currentLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">currentPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">destinationLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">destinationPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1366</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1367</span> </span><span class="WHIT">                        </span><span class="NAME">callback</span><span class="PUNC">(</span><span class="NAME">formatted</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1368</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1369</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1370</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1371</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">options.assistedDialing</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">norm.invalid</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">currentLocale.region</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="NAME">norm.locale.region</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1372</span> </span><span class="WHIT">            </span><span class="COMM">// if this number is not valid for the locale it was parsed with, try again with the current locale</span><span class="WHIT">
<span class='line'>1373</span> </span><span class="WHIT">            </span><span class="COMM">// console.log("norm is invalid. Attempting to reparse with the current locale");</span><span class="WHIT">
<span class='line'>1374</span> 
<span class='line'>1375</span> </span><span class="WHIT">            </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">PhoneNumber</span><span class="PUNC">(</span><span class="NAME">this._join</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1376</span> </span><span class="WHIT">                </span><span class="NAME">locale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">currentLocale</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1377</span> </span><span class="WHIT">                </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1378</span> </span><span class="WHIT">                </span><span class="NAME">loadParms</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1379</span> </span><span class="WHIT">                </span><span class="NAME">onLoad</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">data</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1380</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">data.invalid</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1381</span> </span><span class="WHIT">                        </span><span class="NAME">norm</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">data</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1382</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1383</span> 
<span class='line'>1384</span> </span><span class="WHIT">                    </span><span class="NAME">formatted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._doNormalize</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">norm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">homeLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">currentLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">currentPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">destinationLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">destinationPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1385</span> </span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1386</span> </span><span class="WHIT">                        </span><span class="NAME">callback</span><span class="PUNC">(</span><span class="NAME">formatted</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1387</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1388</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1389</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1390</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1391</span> </span><span class="WHIT">            </span><span class="NAME">formatted</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this._doNormalize</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">norm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">homeLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">currentLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">currentPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">destinationLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">destinationPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1392</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1393</span> </span><span class="WHIT">                </span><span class="NAME">callback</span><span class="PUNC">(</span><span class="NAME">formatted</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1394</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1395</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1396</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1397</span> 
<span class='line'>1398</span> </span><span class="WHIT">    </span><span class="COMM">/**
<span class='line'>1399</span>      * This function normalizes the current phone number to a canonical format and returns a
<span class='line'>1400</span>      * string with that phone number. If parts are missing, this function attempts to fill in
<span class='line'>1401</span>      * those parts.&lt;p>
<span class='line'>1402</span>      *
<span class='line'>1403</span>      * The options object contains a set of properties that can possibly help normalize
<span class='line'>1404</span>      * this number by providing "extra" information to the algorithm. The options
<span class='line'>1405</span>      * parameter may be null or an empty object if no hints can be determined before
<span class='line'>1406</span>      * this call is made. If any particular hint is not
<span class='line'>1407</span>      * available, it does not need to be present in the options object.&lt;p>
<span class='line'>1408</span>      *
<span class='line'>1409</span>      * The following is a list of hints that the algorithm will look for in the options
<span class='line'>1410</span>      * object:
<span class='line'>1411</span>      *
<span class='line'>1412</span>      * &lt;ul>
<span class='line'>1413</span>      * &lt;li>&lt;i>mcc&lt;/i> the mobile carrier code of the current network upon which this
<span class='line'>1414</span>      * phone is operating. This is translated into an IDD country code. This is
<span class='line'>1415</span>      * useful if the number being normalized comes from CNAP (callerid) and the
<span class='line'>1416</span>      * MCC is known.
<span class='line'>1417</span>      * &lt;li>&lt;i>defaultAreaCode&lt;/i> the area code of the phone number of the current
<span class='line'>1418</span>      * device, if available. Local numbers in a person's contact list are most
<span class='line'>1419</span>      * probably in this same area code.
<span class='line'>1420</span>      * &lt;li>&lt;i>country&lt;/i> the 2 letter ISO 3166 code of the country if it is
<span class='line'>1421</span>      * known from some other means such as parsing the physical address of the
<span class='line'>1422</span>      * person associated with the phone number, or the from the domain name
<span class='line'>1423</span>      * of the person's email address
<span class='line'>1424</span>      * &lt;li>&lt;i>networkType&lt;/i> specifies whether the phone is currently connected to a
<span class='line'>1425</span>      * CDMA network or a UMTS network. Valid values are the strings "cdma" and "umts".
<span class='line'>1426</span>      * If one of those two strings are not specified, or if this property is left off
<span class='line'>1427</span>      * completely, this method will assume UMTS.
<span class='line'>1428</span>      * &lt;/ul>
<span class='line'>1429</span>      *
<span class='line'>1430</span>      * The following are a list of options that control the behaviour of the normalization:
<span class='line'>1431</span>      *
<span class='line'>1432</span>      * &lt;ul>
<span class='line'>1433</span>      * &lt;li>&lt;i>assistedDialing&lt;/i> if this is set to true, the number will be normalized
<span class='line'>1434</span>      * so that it can dialled directly on the type of network this phone is
<span class='line'>1435</span>      * currently connected to. This allows customers to dial numbers or use numbers
<span class='line'>1436</span>      * in their contact list that are specific to their "home" region when they are
<span class='line'>1437</span>      * roaming and those numbers would not otherwise work with the current roaming
<span class='line'>1438</span>      * carrier as they are. The home region is
<span class='line'>1439</span>      * specified as the phoneRegion system preference that is settable in the
<span class='line'>1440</span>      * regional settings app. With assisted dialling, this method will add or
<span class='line'>1441</span>      * remove international direct dialling prefixes and country codes, as well as
<span class='line'>1442</span>      * national trunk access codes, as required by the current roaming carrier and the
<span class='line'>1443</span>      * home region in order to dial the number properly. If it is not possible to
<span class='line'>1444</span>      * construct a full international dialling sequence from the options and hints given,
<span class='line'>1445</span>      * this function will not modify the phone number, and will return "undefined".
<span class='line'>1446</span>      * If assisted dialling is false or not specified, then this method will attempt
<span class='line'>1447</span>      * to add all the information it can to the number so that it is as fully
<span class='line'>1448</span>      * specified as possible. This allows two numbers to be compared more easily when
<span class='line'>1449</span>      * those two numbers were otherwise only partially specified.
<span class='line'>1450</span>      * &lt;li>&lt;i>sms&lt;/i> set this option to true for the following conditions:
<span class='line'>1451</span>      *   &lt;ul>
<span class='line'>1452</span>      *   &lt;li>assisted dialing is turned on
<span class='line'>1453</span>      *   &lt;li>the phone number represents the destination of an SMS message
<span class='line'>1454</span>      *   &lt;li>the phone is UMTS
<span class='line'>1455</span>      *   &lt;li>the phone is SIM-locked to its carrier
<span class='line'>1456</span>      *   &lt;/ul>
<span class='line'>1457</span>      * This enables special international direct dialling codes to route the SMS message to
<span class='line'>1458</span>      * the correct carrier. If assisted dialling is not turned on, this option has no
<span class='line'>1459</span>      * affect.
<span class='line'>1460</span>      * &lt;li>&lt;i>manualDialing&lt;/i> set this option to true if the user is entering this number on
<span class='line'>1461</span>      * the keypad directly, and false when the number comes from a stored location like a
<span class='line'>1462</span>      * contact entry or a call log entry. When true, this option causes the normalizer to
<span class='line'>1463</span>      * not perform any normalization on numbers that look like local numbers in the home
<span class='line'>1464</span>      * country. If false, all numbers go through normalization. This option only has an effect
<span class='line'>1465</span>      * when the assistedDialing option is true as well, otherwise it is ignored.
<span class='line'>1466</span>      * &lt;/ul>
<span class='line'>1467</span>      *
<span class='line'>1468</span>      * If both a set of options and a locale are given, and they offer conflicting
<span class='line'>1469</span>      * information, the options will take precedence. The idea is that the locale
<span class='line'>1470</span>      * tells you the region setting that the user has chosen (probably in
<span class='line'>1471</span>      * firstuse), whereas the the hints are more current information such as
<span class='line'>1472</span>      * where the phone is currently operating (the MCC).&lt;p>
<span class='line'>1473</span>      *
<span class='line'>1474</span>      * This function performs the following types of normalizations with assisted
<span class='line'>1475</span>      * dialling turned on:
<span class='line'>1476</span>      *
<span class='line'>1477</span>      * &lt;ol>
<span class='line'>1478</span>      * &lt;li>If the current location of the phone matches the home country, this is a
<span class='line'>1479</span>      * domestic call.
<span class='line'>1480</span>      *   &lt;ul>
<span class='line'>1481</span>      *   &lt;li>Remove any iddPrefix and countryCode fields, as they are not needed
<span class='line'>1482</span>      *   &lt;li>Add in a trunkAccess field that may be necessary to call a domestic numbers
<span class='line'>1483</span>      *     in the home country
<span class='line'>1484</span>      *   &lt;/ul>
<span class='line'>1485</span>      * &lt;li> If the current location of the phone does not match the home country,
<span class='line'>1486</span>      * attempt to form a whole international number.
<span class='line'>1487</span>      *   &lt;ul>
<span class='line'>1488</span>      *   &lt;li>Add in the area code if it is missing from the phone number and the area code
<span class='line'>1489</span>      *     of the current phone is available in the hints
<span class='line'>1490</span>      *   &lt;li>Add the country dialling code for the home country if it is missing from the
<span class='line'>1491</span>      *     phone number
<span class='line'>1492</span>      *   &lt;li>Add or replace the iddPrefix with the correct one for the current country. The
<span class='line'>1493</span>      *     phone number will have been parsed with the settings for the home country, so
<span class='line'>1494</span>      *     the iddPrefix may be incorrect for the
<span class='line'>1495</span>      *     current country. The iddPrefix for the current country can be "+" if the phone
<span class='line'>1496</span>      *     is connected to a UMTS network, and either a "+" or a country-dependent
<span class='line'>1497</span>      *     sequences of digits for CDMA networks.
<span class='line'>1498</span>      *   &lt;/ul>
<span class='line'>1499</span>      * &lt;/ol>
<span class='line'>1500</span>      *
<span class='line'>1501</span>      * This function performs the following types of normalization with assisted
<span class='line'>1502</span>      * dialling turned off:
<span class='line'>1503</span>      *
<span class='line'>1504</span>      * &lt;ul>
<span class='line'>1505</span>      * &lt;li>Normalize the international direct dialing prefix to be a plus or the
<span class='line'>1506</span>      * international direct dialling access code for the current country, depending
<span class='line'>1507</span>      * on the network type.
<span class='line'>1508</span>      * &lt;li>If a number is a local number (ie. it is missing its area code),
<span class='line'>1509</span>      * use a default area code from the hints if available. CDMA phones always know their area
<span class='line'>1510</span>      * code, and GSM/UMTS phones know their area code in many instances, but not always
<span class='line'>1511</span>      * (ie. not on Vodaphone or Telcel phones). If the default area code is not available,
<span class='line'>1512</span>      * do not add it.
<span class='line'>1513</span>      * &lt;li>In assisted dialling mode, if a number is missing its country code,
<span class='line'>1514</span>      * use the current MCC number if
<span class='line'>1515</span>      * it is available to figure out the current country code, and prepend that
<span class='line'>1516</span>      * to the number. If it is not available, leave it off. Also, use that
<span class='line'>1517</span>      * country's settings to parse the number instead of the current format
<span class='line'>1518</span>      * locale.
<span class='line'>1519</span>      * &lt;li>For North American numbers with an area code but no trunk access
<span class='line'>1520</span>      * code, add in the trunk access code.
<span class='line'>1521</span>      * &lt;li>For other countries, if the country code is added in step 3, remove the
<span class='line'>1522</span>      * trunk access code when required by that country's conventions for
<span class='line'>1523</span>      * international calls. If the country requires a trunk access code for
<span class='line'>1524</span>      * international calls and it doesn't exist, add one.
<span class='line'>1525</span>      * &lt;/ul>
<span class='line'>1526</span>      *
<span class='line'>1527</span>      * This method modifies the current object, and also returns a string
<span class='line'>1528</span>      * containing the normalized phone number that can be compared directly against
<span class='line'>1529</span>      * other normalized numbers. The canonical format for phone numbers that is
<span class='line'>1530</span>      * returned from thhomeLocaleis method is simply an uninterrupted and unformatted string
<span class='line'>1531</span>      * of dialable digits.
<span class='line'>1532</span>      *
<span class='line'>1533</span>      * @param {{
<span class='line'>1534</span>      *   mcc:string,
<span class='line'>1535</span>      *   defaultAreaCode:string,
<span class='line'>1536</span>      *   country:string,
<span class='line'>1537</span>      *   networkType:string,
<span class='line'>1538</span>      *   assistedDialing:boolean,
<span class='line'>1539</span>      *   sms:boolean,
<span class='line'>1540</span>      *   manualDialing:boolean
<span class='line'>1541</span>      * }} options an object containing options to help in normalizing.
<span class='line'>1542</span>      * @return {string|undefined} the normalized string, or undefined if the number
<span class='line'>1543</span>      * could not be normalized
<span class='line'>1544</span>      */</span><span class="WHIT">
<span class='line'>1545</span> </span><span class="WHIT">    </span><span class="NAME">normalize</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1546</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">norm</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1547</span> </span><span class="WHIT">            </span><span class="NAME">sync</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1548</span> </span><span class="WHIT">            </span><span class="NAME">loadParams</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1549</span> 
<span class='line'>1550</span> 
<span class='line'>1551</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1552</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.sync</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1553</span> </span><span class="WHIT">                </span><span class="NAME">sync</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">!</span><span class="NAME">options.sync</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1554</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1555</span> 
<span class='line'>1556</span> </span><span class="WHIT">            </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options.loadParams</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1557</span> </span><span class="WHIT">                </span><span class="NAME">loadParams</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">options.loadParams</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1558</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1559</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1560</span> 
<span class='line'>1561</span> </span><span class="WHIT">        </span><span class="COMM">// Clone this number, so we don't mess with the original.</span><span class="WHIT">
<span class='line'>1562</span> </span><span class="WHIT">        </span><span class="COMM">// No need to do this asynchronously because it's a copy constructor which doesn't</span><span class="WHIT">
<span class='line'>1563</span> </span><span class="WHIT">        </span><span class="COMM">// load any extra files.</span><span class="WHIT">
<span class='line'>1564</span> </span><span class="WHIT">        </span><span class="NAME">norm</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">PhoneNumber</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1565</span> 
<span class='line'>1566</span> </span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">normalized</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1567</span> 
<span class='line'>1568</span> </span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.mcc</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.country</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!==</span><span class="WHIT"> </span><span class="STRN">'undefined'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1569</span> </span><span class="WHIT">            </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">PhoneLocale</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1570</span> </span><span class="WHIT">                </span><span class="NAME">mcc</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">options.mcc</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1571</span> </span><span class="WHIT">                </span><span class="NAME">countryCode</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">options.countryCode</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1572</span> </span><span class="WHIT">                </span><span class="NAME">locale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">this.locale</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1573</span> </span><span class="WHIT">                </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1574</span> </span><span class="WHIT">                </span><span class="NAME">loadParams</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1575</span> </span><span class="WHIT">                </span><span class="NAME">onLoad</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">loc</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1576</span> </span><span class="WHIT">                    </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">NumberingPlan</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1577</span> </span><span class="WHIT">                        </span><span class="NAME">locale</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">loc</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1578</span> </span><span class="WHIT">                        </span><span class="NAME">sync</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1579</span> </span><span class="WHIT">                        </span><span class="NAME">loadParms</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>1580</span> </span><span class="WHIT">                        </span><span class="NAME">onLoad</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">ilib.bind</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">plan</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1581</span> </span><span class="WHIT">                            </span><span class="NAME">this._doReparse</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">norm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.locale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">loc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">plan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.destinationLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.destinationPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">fmt</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1582</span> </span><span class="WHIT">                                </span><span class="NAME">normalized</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fmt</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1583</span> 
<span class='line'>1584</span> </span><span class="WHIT">                                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.onLoad</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1585</span> </span><span class="WHIT">                                    </span><span class="NAME">options.onLoad</span><span class="PUNC">(</span><span class="NAME">fmt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1586</span> </span><span class="WHIT">                                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1587</span> </span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1588</span> </span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1589</span> </span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1590</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1591</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1592</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1593</span> </span><span class="WHIT">            </span><span class="NAME">this._doReparse</span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">norm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.locale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.locale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.plan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.destinationLocale</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.destinationPlan</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sync</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">loadParams</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">fmt</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1594</span> </span><span class="WHIT">                </span><span class="NAME">normalized</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fmt</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1595</span> 
<span class='line'>1596</span> </span><span class="WHIT">                </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">options.onLoad</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">===</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1597</span> </span><span class="WHIT">                    </span><span class="NAME">options.onLoad</span><span class="PUNC">(</span><span class="NAME">fmt</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1598</span> </span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1599</span> </span><span class="WHIT">            </span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1600</span> </span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1601</span> 
<span class='line'>1602</span> </span><span class="WHIT">        </span><span class="COMM">// return the value for the synchronous case</span><span class="WHIT">
<span class='line'>1603</span> </span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">normalized</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1604</span> </span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1605</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1606</span> 
<span class='line'>1607</span> </span><span class="NAME">module.exports</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">PhoneNumber</span><span class="PUNC">;</span></pre></body></html>