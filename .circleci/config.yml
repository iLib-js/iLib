version: 2.1
jobs:
  test:
    parameters:
        docker_image:
          type: string
          default: cimg/openjdk:8.0-node

    docker:
      - image: << parameters.docker_image >>

    environment:
      NODE_OPTIONS: "--max-old-space-size=3072"
      TZ: "America/Los_Angeles"

    steps:
      - checkout

      - run:
          name: Set up ant
          command: |
            sudo apt update
            sudo apt install -y ant

      - run:
          name: Set up QT
          command: |
            #sudo apt-add-repository --yes ppa:beineri/opt-qt551-trusty
            #sudo apt update
            sudo apt install -y build-essential libfontconfig1 mesa-common-dev qmlscene qt5-default qtdeclarative5-dev qtbase5-dev

      - run:
          name: Set up node packages
          command: |
            rm -rf node_modules package-lock.json
            echo "node version: " $(node -v)
            echo "npm version: " $(npm -v)
            npm install

      - run:
          name: Check environment
          command: |
            echo "node version: " $(node -v)
            echo "npm version: " $(npm -v)
            echo "java version: " $(java -version)
            echo "ant version: " $(ant -version)
            echo "qmake version: " $(qmake --version)
            echo "TZ is $TZ"
            echo "NODE_OPTIONS is $NODE_OPTIONS"

      - run:
          name: Running all unit tests
          command: |
            export PATH="$PWD/node_modules/.bin:$PATH"
            ant clean test.travis

workflows:
  version: 2
  test-all-node-versions:
    jobs:
      - test:
          docker_image: circleci/node:8-browsers
      - test:
          docker_image: circleci/node:10-browsers
      - test:
          docker_image: circleci/node:12-browsers
      - test:
          docker_image: circleci/node:14-browsers
      - test:
          docker_image: circleci/node:16-browsers
